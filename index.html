<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>VigoChatt</title>
  <meta name="theme-color" content="#efe7db"/>

  <style>
    :root{
      --bg:#efe7db;
      --card:rgba(0,0,0,.06);
      --text:#1b1b1b;
      --muted:rgba(0,0,0,.55);
      --border:rgba(0,0,0,.10);
      --accent:#2b6cff;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --radius:18px;
      --shadow: 0 10px 28px rgba(0,0,0,.08);
    }
    [data-theme="dark"]{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --text:#eef2ff;
      --muted:rgba(255,255,255,.60);
      --border:rgba(255,255,255,.12);
      --accent:#6aa2ff;
      --shadow: 0 10px 28px rgba(0,0,0,.30);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 600px at 60% 10%, rgba(255,255,255,.75), transparent 60%),
        radial-gradient(900px 600px at 10% 90%, rgba(255,255,255,.60), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
    }
    [data-theme="dark"] body{
      background:
        radial-gradient(900px 600px at 60% 10%, rgba(106,162,255,.18), transparent 60%),
        radial-gradient(900px 600px at 10% 90%, rgba(255,255,255,.05), transparent 60%),
        var(--bg);
    }

    .app{
      max-width:520px;
      margin:0 auto;
      height:100dvh;
      display:flex;
      flex-direction:column;
      padding-top: var(--safe-top);
      padding-bottom: calc(84px + var(--safe-bottom));
    }

    /* Header */
    .header{
      padding:14px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      background: rgba(43,108,255,.12);
      border:1px solid rgba(43,108,255,.22);
      box-shadow: var(--shadow);
      font-weight:1000;
      color:var(--accent);
      flex:0 0 auto;
    }
    .header h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .header small{color:var(--muted)}
    .hdrActions{display:flex; gap:8px; align-items:center;}
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      box-shadow: var(--shadow);
    }
    [data-theme="dark"] .pill{background: rgba(255,255,255,.08)}
    .pill:active{transform:scale(.98)}
    .pill.icon{padding:10px 11px; width:44px; display:grid; place-items:center;}
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 3px rgba(34,197,94,.18);
      display:inline-block;
      margin-left:6px;
    }

    /* Views */
    .view{
      display:none;
      padding: 6px 16px 16px;
      overflow:auto;
      flex:1;
      -webkit-overflow-scrolling: touch;
    }
    .view.active{display:block}

    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
    }
    [data-theme="dark"] .card{background: rgba(255,255,255,.06)}
    .card h2{margin:0 0 10px; font-size:16px}
    .muted{color:var(--muted); font-size:13px; line-height:1.35}

    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      display:flex; align-items:center; gap:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      border-radius: 16px;
      padding: 12px;
      cursor:pointer;
      user-select:none;
      box-shadow: var(--shadow);
    }
    [data-theme="dark"] .item{background: rgba(255,255,255,.06)}
    .item:active{transform:scale(.99)}
    .avatar{
      width:44px;height:44px;border-radius:16px;
      background: rgba(43,108,255,.12);
      border:1px solid rgba(43,108,255,.18);
      display:grid; place-items:center;
      font-weight:900;
      color:var(--accent);
      flex:0 0 auto;
      overflow:hidden;
    }
    .avatar .aTxt{font-weight:1000}
    .meta{min-width:0; flex:1}
    .meta b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta span{display:block; font-size:13px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:3px}
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      color:var(--muted);
      flex:0 0 auto;
    }
    [data-theme="dark"] .badge{background: rgba(255,255,255,.06)}
    .badge.ok{color:var(--text); border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}

    /* Inputs */
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{display:flex; flex-direction:column; gap:6px; flex:1; min-width:140px}
    input, textarea, select{
      width:100%;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      border-radius: 14px;
      padding: 12px;
      outline:none;
      font-size:14px;
      color:var(--text);
    }
    [data-theme="dark"] input,
    [data-theme="dark"] textarea,
    [data-theme="dark"] select{
      background: rgba(255,255,255,.06);
    }
    textarea{min-height:90px; resize:none}

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      padding:12px 14px;
      border-radius: 14px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow: var(--shadow);
    }
    [data-theme="dark"] .btn{background: rgba(255,255,255,.06)}
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color: rgba(43,108,255,.30);
      background: rgba(43,108,255,.12);
      color: var(--accent);
    }
    .btn.danger{
      border-color: rgba(239,68,68,.30);
      background: rgba(239,68,68,.10);
      color: #ef4444;
    }

    /* Chat overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none;
      z-index: 50;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }
    [data-theme="dark"] .overlay{background: rgba(0,0,0,.35)}
    .overlay.show{display:block}

    .chat{
      max-width:520px;
      margin:0 auto;
      height:100%;
      display:flex;
      flex-direction:column;
      background: rgba(255,255,255,.50);
      border-left:1px solid var(--border);
      border-right:1px solid var(--border);
    }
    [data-theme="dark"] .chat{background: rgba(255,255,255,.06)}
    .chatTop{
      padding: 12px 14px;
      display:flex; align-items:center; gap:10px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.55);
    }
    [data-theme="dark"] .chatTop{background: rgba(255,255,255,.06)}
    .iconBtn{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    [data-theme="dark"] .iconBtn{background: rgba(255,255,255,.06)}
    .iconBtn:active{transform:scale(.98)}
    .chatTitle{min-width:0; flex:1}
    .chatTitle b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .chatTitle span{display:block; font-size:12px; color:var(--muted)}

    .chatBody{
      flex:1;
      overflow:auto;
      padding: 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      -webkit-overflow-scrolling: touch;
    }
    .bubble{
      max-width:78%;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      font-size:14px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
      box-shadow: var(--shadow);
    }
    [data-theme="dark"] .bubble{background: rgba(255,255,255,.06)}
    .bubble.me{
      margin-left:auto;
      background: rgba(43,108,255,.12);
      border-color: rgba(43,108,255,.20);
    }
    .bubble .time{font-size:11px; color:var(--muted); margin-top:6px}
    .composer{
      padding: 10px 14px calc(10px + var(--safe-bottom));
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.55);
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    [data-theme="dark"] .composer{background: rgba(255,255,255,.06)}
    .composer textarea{
      flex:1;
      min-height:44px;
      max-height:140px;
      resize:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      border-radius: 16px;
      padding: 12px;
      outline:none;
      font-size:14px;
    }
    [data-theme="dark"] .composer textarea{background: rgba(255,255,255,.06)}
    .send{
      width:52px;height:52px;
      border-radius:16px;
      border:1px solid rgba(43,108,255,.25);
      background: rgba(43,108,255,.12);
      color: var(--accent);
      font-weight:1000;
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
      box-shadow: var(--shadow);
    }
    .send:active{transform:scale(.99)}

    /* Bottom bar */
    .bottom{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:9999;
      padding: 10px 12px calc(10px + var(--safe-bottom));
      display:flex;
      justify-content:center;
    }
    .nav{
      width:min(520px, calc(100% - 24px));
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      border-radius: 22px;
      padding: 10px;
      display:flex;
      gap:8px;
      box-shadow: var(--shadow);
    }
    [data-theme="dark"] .nav{background: rgba(255,255,255,.06)}
    .tab{
      flex:1;
      border-radius: 16px;
      padding: 10px 6px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
      color:var(--muted);
      border:1px solid transparent;
    }
    .tab.active{
      color: var(--text);
      background: rgba(43,108,255,.10);
      border-color: rgba(43,108,255,.18);
    }
    .tab .ico{font-size:20px; line-height:1}
    .tab .lbl{font-size:12px; font-weight:900}

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      z-index:80;
      background: rgba(0,0,0,.20);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      padding: calc(14px + var(--safe-top)) 14px calc(14px + var(--safe-bottom));
    }
    [data-theme="dark"] .modal{background: rgba(0,0,0,.45)}
    .modal.show{display:block}
    .sheet{
      max-width:520px;
      margin:0 auto;
      background: rgba(255,255,255,.70);
      border:1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    [data-theme="dark"] .sheet{background: rgba(255,255,255,.08)}
    .sheetHd{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border);
    }
    .sheetHd b{font-size:14px}
    .sheetBd{padding:14px}
    .hr{height:1px; background:var(--border); margin:12px 0}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: calc(92px + var(--safe-bottom));
      transform: translateX(-50%);
      z-index: 99999;
      background: rgba(0,0,0,.78);
      color:white;
      padding:10px 12px;
      border-radius: 999px;
      font-size:13px;
      display:none;
      max-width: calc(100% - 24px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{display:block}

    /* Hide */
    .hidden{display:none !important;}
  </style>
</head>

<body>
  <div class="toast" id="toast">...</div>

  <div class="app" id="appRoot">
    <div class="header">
      <div class="brand">
        <div class="logo" id="logoBox">V</div>
        <div style="min-width:0">
          <h1 id="title">VigoChatt</h1>
          <small id="sub">Baƒülanƒ±yor...</small>
        </div>
      </div>

      <div class="hdrActions">
        <div class="pill icon" id="themeBtn" title="Tema">‚òæ</div>
        <div class="pill" id="addBtn" title="Yeni sohbet">Ôºã</div>
      </div>
    </div>

    <!-- AUTH -->
    <section class="view active" id="view-auth">
      <div class="card">
        <h2>Giri≈ü / Kayƒ±t</h2>
        <div class="muted" style="margin-bottom:10px">
          VigoChatt‚Äôe giri≈ü yap. Arkada≈üƒ±n da kayƒ±t olursa ger√ßek mesajla≈üƒ±rsƒ±n.
        </div>

        <div class="field">
          <label class="muted">E-posta</label>
          <input id="email" type="email" placeholder="ornek@mail.com" autocomplete="email">
        </div>
        <div class="field">
          <label class="muted">≈ûifre</label>
          <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="loginBtn" type="button">Giri≈ü Yap</button>
          <button class="btn" id="signupBtn" type="button">Kayƒ±t Ol</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Not: Numara ile giri≈ü + rehber + WhatsApp gibi sesli arama i√ßin Android native gerekir.
          Bu s√ºr√ºmde (tek dosya) en saƒülam √ßalƒ±≈üan sistem: e-posta ile ger√ßek Firebase chat.
        </div>

        <div id="authErr" style="color:#ef4444;margin-top:10px;font-size:13px"></div>
      </div>
    </section>

    <!-- Calls -->
    <section class="view" id="view-calls">
      <div class="card">
        <b>Aramalar</b>
        <div class="muted" style="margin-top:6px">
          Bu sekme hazƒ±r. WhatsApp gibi ger√ßek sesli arama i√ßin (WebRTC + signaling server / native) gerekir.
          APK‚Äôde √ßalƒ±≈ümasƒ± i√ßin ‚Äúnative/Capacitor‚Äù kurulum yaparƒ±z.
        </div>
        <div class="hr"></div>
        <button class="btn" id="callInfoBtn">Sesli arama nasƒ±l eklenir?</button>
      </div>
      <div class="list" id="callsList"></div>
    </section>

    <!-- Status -->
    <section class="view" id="view-status">
      <div class="card">
        <b>Durum</b>
        <div class="muted" style="margin-top:6px">
          Durumunu yaz ve payla≈ü. (Firebase‚Äôe kaydolur)
        </div>
        <div class="hr"></div>
        <div class="row">
          <input id="statusInput" placeholder="Durum yaz... (√∂r: dƒ±≈üarƒ±dayƒ±m)">
          <button class="btn primary" id="statusAddBtn">Payla≈ü</button>
        </div>
      </div>

      <div class="card">
        <b>Son Durumlarƒ±n</b>
        <div class="muted" style="margin-top:6px">En son payla≈ütƒ±klarƒ±n</div>
      </div>
      <div class="list" id="statusList"></div>
    </section>

    <!-- Messages -->
    <section class="view" id="view-messages">
      <div class="card">
        <b>Mesajlar</b>
        <div class="muted" style="margin-top:6px">
          ‚ÄúÔºã‚Äù ile arkada≈üƒ±nƒ±n e-postasƒ±nƒ± yaz ‚Üí sohbet a√ß ‚Üí mesaj g√∂nder.
        </div>
      </div>
      <div class="list" id="chatList"></div>
      <div class="card hidden" id="emptyInbox">
        <b>Hen√ºz sohbet yok</b>
        <div class="muted" style="margin-top:6px">
          √ústteki ‚ÄúÔºã‚Äù ile yeni sohbet ba≈ülat.
        </div>
      </div>
    </section>

    <!-- Profile -->
    <section class="view" id="view-profile">
      <div class="card">
        <b>Profil</b>
        <div class="muted" style="margin-top:6px">Profilini d√ºzenle (Firebase‚Äôe kaydolur).</div>
      </div>

      <div class="card">
        <div class="row">
          <div class="field">
            <label class="muted">Ad</label>
            <input id="pName" placeholder="Adƒ±n">
          </div>
          <div class="field">
            <label class="muted">Doƒüum g√ºn√º</label>
            <input id="pBday" type="date">
          </div>
        </div>
        <div class="field" style="margin-top:10px">
          <label class="muted">Hakkƒ±nda</label>
          <textarea id="pAbout" placeholder="Kƒ±sa biyografi..."></textarea>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="saveProfileBtn">Kaydet</button>
          <button class="btn" id="openSettingsBtn">Ayarlar</button>
          <button class="btn danger" id="logoutBtn">√áƒ±kƒ±≈ü</button>
        </div>

        <div class="hr"></div>
        <div class="muted" id="meInfo">‚Äî</div>
      </div>
    </section>
  </div>

  <!-- Chat overlay -->
  <div class="overlay" id="overlay">
    <div class="chat">
      <div class="chatTop">
        <div class="iconBtn" id="back" title="Geri">‚Üê</div>

        <div class="chatTitle">
          <b id="chatName">Sohbet</b>
          <span id="chatSub">‚Äî</span>
        </div>

        <div class="iconBtn" id="more" title="Men√º">‚ãØ</div>
      </div>

      <div class="chatBody" id="chatBody"></div>

      <div class="composer">
        <textarea id="msg" rows="1" placeholder="Mesaj yaz..."></textarea>
        <div class="send" id="send" title="G√∂nder">‚û§</div>
      </div>
    </div>
  </div>

  <!-- Bottom nav -->
  <div class="bottom">
    <nav class="nav">
      <div class="tab" data-tab="calls"><div class="ico">üë•</div><div class="lbl">Aramalar</div></div>
      <div class="tab" data-tab="status"><div class="ico">‚ùó</div><div class="lbl">Durum</div></div>
      <div class="tab active" data-tab="messages"><div class="ico">üí¨</div><div class="lbl">Mesajlar</div></div>
      <div class="tab" data-tab="profile"><div class="ico">üôÇ</div><div class="lbl">Profil</div></div>
    </nav>
  </div>

  <!-- Modal: New Chat -->
  <div class="modal" id="newChatModal">
    <div class="sheet">
      <div class="sheetHd">
        <b>Yeni Sohbet</b>
        <div class="iconBtn" id="closeNewChat" title="Kapat">‚úï</div>
      </div>
      <div class="sheetBd">
        <div class="muted">Arkada≈üƒ±nƒ±n VigoChatt‚Äôte kayƒ±t olduƒüu <b>e-posta</b> adresini yaz.</div>
        <div class="hr"></div>

        <div class="field">
          <label class="muted">E-posta</label>
          <input id="newChatEmail" placeholder="arkadas@mail.com" autocomplete="email">
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="startChatBtn">Sohbet Ba≈ülat</button>
          <button class="btn" id="copyMyEmailBtn">Benim e-postamƒ± kopyala</button>
        </div>

        <div id="newChatErr" style="color:#ef4444;margin-top:10px;font-size:13px"></div>
      </div>
    </div>
  </div>

  <!-- Modal: Settings -->
  <div class="modal" id="settingsModal">
    <div class="sheet">
      <div class="sheetHd">
        <b>Ayarlar</b>
        <div class="iconBtn" id="closeSettings" title="Kapat">‚úï</div>
      </div>
      <div class="sheetBd">
        <div class="card" style="margin:0">
          <b>G√∂r√ºn√ºm</b>
          <div class="muted" style="margin-top:6px">Tema se√ßimi</div>
          <div class="hr"></div>
          <div class="row">
            <button class="btn" id="themeLightBtn">A√ßƒ±k</button>
            <button class="btn" id="themeDarkBtn">Koyu</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="card" style="margin:0">
          <b>Hakkƒ±nda</b>
          <div class="muted" style="margin-top:6px">
            VigoChatt ‚Ä¢ Firebase ger√ßek mesajla≈üma (tek dosya s√ºr√ºm)
          </div>
          <div class="hr"></div>
          <div class="muted">
            Rehber ve sesli arama i√ßin Android native gerekir.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Chat Menu -->
  <div class="modal" id="chatMenuModal">
    <div class="sheet">
      <div class="sheetHd">
        <b>Sohbet Men√ºs√º</b>
        <div class="iconBtn" id="closeChatMenu" title="Kapat">‚úï</div>
      </div>
      <div class="sheetBd">
        <button class="btn" id="clearChatBtn">Bu cihazda sohbeti temizle</button>
        <div class="hr"></div>
        <button class="btn danger" id="closeChatBtn2">Sohbeti kapat</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
      getDatabase,
      ref,
      set,
      get,
      update,
      push,
      onValue,
      query,
      orderByChild,
      equalTo,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // === SENƒ∞N FIREBASE CONFIG (Aynen) ===
    const firebaseConfig = {
      apiKey: "AIzaSyA3--Xy1WrM6WlxurXXr4i5qwMZiafXN4k",
      authDomain: "vigochat-58144.firebaseapp.com",
      databaseURL: "https://vigochat-58144-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "vigochat-58144",
      storageBucket: "vigochat-58144.firebasestorage.app",
      messagingSenderId: "384136632816",
      appId: "1:384136632816:web:2bb6d6942680a2e2e6e535",
      measurementId: "G-62VZ3906GS"
    };

    // ===== Helpers =====
    const $ = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.classList.remove("show"), 2200);
    }
    function fmtTime(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
      }catch{ return ""; }
    }
    function themeSet(mode){
      const root = document.documentElement;
      root.dataset.theme = mode;
      localStorage.setItem("vigo_theme", mode);
      $("#themeBtn").textContent = (mode==="dark") ? "‚òÄ" : "‚òæ";
      document.querySelector('meta[name="theme-color"]')?.setAttribute("content", mode==="dark" ? "#0b1220" : "#efe7db");
    }

    // ===== Init Theme =====
    themeSet(localStorage.getItem("vigo_theme") || "light");

    // ===== Firebase Init =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ===== State =====
    let me = null;                 // auth user
    let myProfile = null;          // db profile
    let inboxUnsub = null;         // onValue unsub? (we will just keep reference)
    let statusUnsub = null;
    let currentThreadId = null;
    let currentOther = null;       // {uid, name}
    let messagesUnsub = null;

    // Paths:
    // profiles/{uid} -> {emailLower, name, about, bday, color, online, lastSeen}
    // inbox/{uid}/{threadId} -> {otherUid, otherName, otherColor, lastText, lastAt}
    // messages/{threadId}/{msgId} -> {uid, text, at}
    // statuses/{uid}/{statusId} -> {text, at}

    function uidColor(uid){
      // stable pastel color
      let h = 0;
      for(let i=0;i<uid.length;i++) h = (h*31 + uid.charCodeAt(i)) % 360;
      return `hsl(${h} 70% 60%)`;
    }

    function setOnlineSub(){
      if(!me) return;
      const pRef = ref(db, `profiles/${me.uid}`);
      // Basit presence: online true + lastSeen (serverTimestamp)
      update(pRef, { online:true, lastSeen: Date.now() }).catch(()=>{});
      window.addEventListener("beforeunload", ()=>{
        update(pRef, { online:false, lastSeen: Date.now() }).catch(()=>{});
      });
    }

    // ===== UI Tabs =====
    function setTab(tab){
      $$(".tab").forEach(t=> t.classList.toggle("active", t.dataset.tab === tab));
      ["calls","status","messages","profile","auth"].forEach(v=>{
        const view = $("#view-" + v);
        if(view) view.classList.toggle("active", v === tab);
      });

      const titles = {calls:"Aramalar", status:"Durum", messages:"VigoChatt", profile:"Profil", auth:"VigoChatt"};
      $("#title").textContent = titles[tab] || "VigoChatt";
      $("#sub").textContent = me ? (myProfile?.name ? `Merhaba, ${myProfile.name}` : "√áevrimi√ßi") : "Basit mesajla≈üma";

      closeChat();
    }

    // ===== Modals =====
    function modalShow(id, on=true){ $(id).classList.toggle("show", on); }
    function showNewChat(on=true){
      $("#newChatErr").textContent = "";
      $("#newChatEmail").value = "";
      modalShow("#newChatModal", on);
      if(on) setTimeout(()=> $("#newChatEmail").focus(), 50);
    }
    function showSettings(on=true){ modalShow("#settingsModal", on); }
    function showChatMenu(on=true){ modalShow("#chatMenuModal", on); }

    // ===== Chat Overlay =====
    function openChat(threadId, other){
      currentThreadId = threadId;
      currentOther = other;

      $("#chatName").textContent = other?.name || "Sohbet";
      $("#chatSub").textContent = "baƒülanƒ±yor...";
      $("#chatBody").innerHTML = "";

      $("#overlay").classList.add("show");
      listenMessages(threadId, other.uid);
      $("#msg").value = "";
      $("#msg").focus();
    }
    function closeChat(){
      $("#overlay").classList.remove("show");
      currentThreadId = null;
      currentOther = null;
      $("#msg").value = "";

      // stop listening
      if(messagesUnsub){
        // onValue returns callback removal via off(), but modular doesn't directly give unsub.
        // We'll just keep single listener per open; re-open will overwrite and old stays minimal.
        messagesUnsub = null;
      }
    }

    // ===== AUTH =====
    async function signupEmail(){
      $("#authErr").textContent = "";
      const email = $("#email").value.trim();
      const pass = $("#pass").value;
      if(!email || !pass || pass.length < 6){
        $("#authErr").textContent = "E-posta ve en az 6 karakter ≈üifre gir.";
        return;
      }
      try{
        await createUserWithEmailAndPassword(auth, email, pass);
      }catch(e){
        $("#authErr").textContent = (e?.message || "Kayƒ±t hatasƒ±");
      }
    }
    async function loginEmail(){
      $("#authErr").textContent = "";
      const email = $("#email").value.trim();
      const pass = $("#pass").value;
      if(!email || !pass){
        $("#authErr").textContent = "E-posta ve ≈üifre gir.";
        return;
      }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){
        $("#authErr").textContent = (e?.message || "Giri≈ü hatasƒ±");
      }
    }
    async function logout(){
      try{
        if(me){
          await update(ref(db, `profiles/${me.uid}`), { online:false, lastSeen: Date.now() });
        }
      }catch{}
      await signOut(auth);
    }

    // ===== Profile load/save =====
    async function ensureProfile(user){
      const pRef = ref(db, `profiles/${user.uid}`);
      const snap = await get(pRef);
      const emailLower = (user.email || "").toLowerCase();
      if(!snap.exists()){
        const base = {
          email: user.email || "",
          emailLower,
          name: "",
          about: "",
          bday: "",
          color: uidColor(user.uid),
          online: true,
          lastSeen: Date.now(),
          createdAt: Date.now()
        };
        await set(pRef, base);
        return base;
      }
      const v = snap.val();
      // keep emailLower updated
      if(v.emailLower !== emailLower){
        await update(pRef, { email: user.email || "", emailLower });
      }
      return { ...v, email: user.email || v.email || "" };
    }

    async function saveProfile(){
      if(!me) return;
      const name = $("#pName").value.trim();
      const about = $("#pAbout").value.trim();
      const bday = $("#pBday").value;

      const pRef = ref(db, `profiles/${me.uid}`);
      await update(pRef, { name, about, bday, lastSeen: Date.now() });
      toast("Profil kaydedildi");
    }

    function paintProfileUI(){
      $("#pName").value = myProfile?.name || "";
      $("#pAbout").value = myProfile?.about || "";
      $("#pBday").value = myProfile?.bday || "";
      $("#meInfo").innerHTML = `
        <div><b>E-posta:</b> ${escapeHtml(me?.email || "-")}</div>
        <div><b>UID:</b> ${escapeHtml(me?.uid || "-")}</div>
      `;
      $("#logoBox").style.borderColor = "rgba(43,108,255,.22)";
      $("#logoBox").style.color = "var(--accent)";
      $("#logoBox").textContent = (myProfile?.name?.[0] || "V").toUpperCase();
    }

    // ===== Inbox / Threads =====
    function threadIdFor(u1, u2){
      return [u1, u2].sort().join("_");
    }

    async function findUserByEmail(email){
      const e = email.trim().toLowerCase();
      if(!e) return null;
      const q = query(ref(db, "profiles"), orderByChild("emailLower"), equalTo(e));
      const snap = await get(q);
      if(!snap.exists()) return null;
      const obj = snap.val();
      const uid = Object.keys(obj)[0];
      return { uid, ...obj[uid] };
    }

    async function startChatWithEmail(email){
      $("#newChatErr").textContent = "";
      if(!me) return;
      const other = await findUserByEmail(email);
      if(!other){
        $("#newChatErr").textContent = "Bu e-posta ile kayƒ±tlƒ± kullanƒ±cƒ± yok. Arkada≈üƒ±n √∂nce kayƒ±t olsun.";
        return;
      }
      if(other.uid === me.uid){
        $("#newChatErr").textContent = "Kendi e-postanla sohbet a√ßamazsƒ±n üôÇ";
        return;
      }

      const tid = threadIdFor(me.uid, other.uid);

      // create minimal inbox entries if not exist
      const myInboxRef = ref(db, `inbox/${me.uid}/${tid}`);
      const otherInboxRef = ref(db, `inbox/${other.uid}/${tid}`);

      // my view of other
      await update(myInboxRef, {
        otherUid: other.uid,
        otherName: other.name || other.email || "Kullanƒ±cƒ±",
        otherColor: other.color || uidColor(other.uid),
        lastText: "",
        lastAt: Date.now()
      });

      // other view of me
      const meName = myProfile?.name || me.email || "Kullanƒ±cƒ±";
      await update(otherInboxRef, {
        otherUid: me.uid,
        otherName: meName,
        otherColor: myProfile?.color || uidColor(me.uid),
        lastText: "",
        lastAt: Date.now()
      });

      showNewChat(false);
      toast("Sohbet hazƒ±r");
      openChat(tid, { uid: other.uid, name: other.name || other.email || "Kullanƒ±cƒ±", color: other.color || uidColor(other.uid) });
      setTab("messages");
    }

    function renderInboxItem(threadId, v){
      const name = v?.otherName || "Kullanƒ±cƒ±";
      const last = v?.lastText || "Hen√ºz mesaj yok";
      const color = v?.otherColor || "rgba(43,108,255,.12)";
      const onlineMark = v?.otherOnline ? `<span class="dot"></span>` : "";

      const initials = (name.trim()[0] || "V").toUpperCase();
      return `
        <div class="item" data-thread="${escapeHtml(threadId)}" data-ouid="${escapeHtml(v.otherUid||"")}" data-oname="${escapeHtml(name)}">
          <div class="avatar" style="background:${escapeHtml(color)}22;border-color:${escapeHtml(color)}55">
            <div class="aTxt">${escapeHtml(initials)}</div>
          </div>
          <div class="meta">
            <b>${escapeHtml(name)} ${onlineMark}</b>
            <span>${escapeHtml(last)}</span>
          </div>
          <div class="badge">${v?.lastAt ? escapeHtml(fmtTime(v.lastAt)) : ""}</div>
        </div>
      `;
    }

    function listenInbox(){
      if(!me) return;
      const listEl = $("#chatList");
      const emptyEl = $("#emptyInbox");
      listEl.innerHTML = "";
      emptyEl.classList.add("hidden");

      const inboxRef = ref(db, `inbox/${me.uid}`);
      onValue(inboxRef, async (snap)=>{
        const data = snap.val() || {};
        const entries = Object.entries(data)
          .map(([tid, v])=> ({tid, ...v}))
          .sort((a,b)=> (b.lastAt||0) - (a.lastAt||0));

        if(entries.length === 0){
          listEl.innerHTML = "";
          emptyEl.classList.remove("hidden");
          $("#callsList").innerHTML = "";
          return;
        }

        // Update online statuses (light)
        // read each other profile online
        const otherUids = Array.from(new Set(entries.map(e=> e.otherUid).filter(Boolean)));
        const onlineMap = {};
        await Promise.all(otherUids.slice(0,30).map(async uid=>{
          try{
            const p = await get(ref(db, `profiles/${uid}`));
            if(p.exists()){
              onlineMap[uid] = !!p.val().online;
            }
          }catch{}
        }));

        const html = entries.map(e=>{
          e.otherOnline = onlineMap[e.otherUid] || false;
          return renderInboxItem(e.tid, e);
        }).join("");
        listEl.innerHTML = html;

        // Calls list: show same people as shortcuts
        $("#callsList").innerHTML = entries.slice(0,12).map(e=>`
          <div class="item" data-call="${escapeHtml(e.tid)}" data-ouid="${escapeHtml(e.otherUid||"")}" data-oname="${escapeHtml(e.otherName||"Kullanƒ±cƒ±")}">
            <div class="avatar"><div class="aTxt">üìû</div></div>
            <div class="meta">
              <b>${escapeHtml(e.otherName || "Kullanƒ±cƒ±")}</b>
              <span>Sesli arama: native gerekir</span>
            </div>
            <div class="badge">Ara</div>
          </div>
        `).join("");
      });
    }

    // ===== Messages =====
    function listenMessages(threadId, otherUid){
      const box = $("#chatBody");
      box.innerHTML = "";

      const mRef = ref(db, `messages/${threadId}`);
      onValue(mRef, async (snap)=>{
        const data = snap.val() || {};
        const arr = Object.entries(data)
          .map(([k,v])=> ({k, ...v}))
          .sort((a,b)=> (a.at||0) - (b.at||0))
          .slice(-250);

        // get other online
        try{
          const p = await get(ref(db, `profiles/${otherUid}`));
          if(p.exists()){
            const pv = p.val();
            $("#chatSub").textContent = pv.online ? "√ßevrimi√ßi" : ("son g√∂r√ºlme: " + fmtTime(pv.lastSeen || Date.now()));
          }else{
            $("#chatSub").textContent = "‚Äî";
          }
        }catch{
          $("#chatSub").textContent = "‚Äî";
        }

        box.innerHTML = arr.map(m=>{
          const isMe = (m.uid === me.uid);
          return `
            <div class="bubble ${isMe ? "me":""}">
              ${escapeHtml(m.text || "")}
              <div class="time">${escapeHtml(fmtTime(m.at || Date.now()))}</div>
            </div>
          `;
        }).join("");
        box.scrollTop = box.scrollHeight;
      });
    }

    async function sendMsg(){
      if(!me || !currentThreadId || !currentOther) return;
      const t = $("#msg").value.trim();
      if(!t) return;

      $("#msg").value = "";
      const now = Date.now();

      const mRef = ref(db, `messages/${currentThreadId}`);
      await push(mRef, { uid: me.uid, text: t, at: now });

      // update inbox for both
      const myInboxRef = ref(db, `inbox/${me.uid}/${currentThreadId}`);
      const otherInboxRef = ref(db, `inbox/${currentOther.uid}/${currentThreadId}`);

      await update(myInboxRef, {
        otherUid: currentOther.uid,
        otherName: currentOther.name || "Kullanƒ±cƒ±",
        otherColor: currentOther.color || uidColor(currentOther.uid),
        lastText: t,
        lastAt: now
      });

      const meName = myProfile?.name || me.email || "Kullanƒ±cƒ±";
      await update(otherInboxRef, {
        otherUid: me.uid,
        otherName: meName,
        otherColor: myProfile?.color || uidColor(me.uid),
        lastText: t,
        lastAt: now
      });
    }

    // ===== Status =====
    async function addStatus(){
      if(!me) return;
      const text = $("#statusInput").value.trim();
      if(!text) return;
      $("#statusInput").value = "";

      const sRef = ref(db, `statuses/${me.uid}`);
      await push(sRef, { text, at: Date.now() });
      toast("Durum payla≈üƒ±ldƒ±");
    }

    function listenMyStatuses(){
      if(!me) return;
      const list = $("#statusList");
      list.innerHTML = "";

      const sRef = ref(db, `statuses/${me.uid}`);
      onValue(sRef, (snap)=>{
        const data = snap.val() || {};
        const arr = Object.entries(data)
          .map(([k,v])=> ({k,...v}))
          .sort((a,b)=> (b.at||0) - (a.at||0))
          .slice(0,30);

        if(arr.length === 0){
          list.innerHTML = `
            <div class="card">
              <b>Durum yok</b>
              <div class="muted" style="margin-top:6px">Yukarƒ±dan durum payla≈ü.</div>
            </div>
          `;
          return;
        }

        list.innerHTML = arr.map(s=>`
          <div class="item" style="cursor:default">
            <div class="avatar"><div class="aTxt">‚ùó</div></div>
            <div class="meta">
              <b>${escapeHtml(myProfile?.name || "Sen")}</b>
              <span>${escapeHtml(s.text || "")}</span>
            </div>
            <div class="badge">${escapeHtml(fmtTime(s.at || Date.now()))}</div>
          </div>
        `).join("");
      });
    }

    // ===== Wire UI events =====
    $("#loginBtn").addEventListener("click", loginEmail);
    $("#signupBtn").addEventListener("click", signupEmail);

    $("#logoutBtn").addEventListener("click", logout);
    $("#saveProfileBtn").addEventListener("click", saveProfile);

    $("#themeBtn").addEventListener("click", ()=>{
      const cur = document.documentElement.dataset.theme || "light";
      themeSet(cur === "dark" ? "light" : "dark");
      toast(cur === "dark" ? "A√ßƒ±k tema" : "Koyu tema");
    });

    $("#openSettingsBtn").addEventListener("click", ()=> showSettings(true));
    $("#closeSettings").addEventListener("click", ()=> showSettings(false));
    $("#settingsModal").addEventListener("click", (e)=>{ if(e.target.id==="settingsModal") showSettings(false); });

    $("#themeLightBtn").addEventListener("click", ()=>{ themeSet("light"); toast("A√ßƒ±k tema"); });
    $("#themeDarkBtn").addEventListener("click", ()=>{ themeSet("dark"); toast("Koyu tema"); });

    $("#addBtn").addEventListener("click", ()=>{
      if(!me){ toast("√ñnce giri≈ü yap"); setTab("auth"); return; }
      showNewChat(true);
    });
    $("#closeNewChat").addEventListener("click", ()=> showNewChat(false));
    $("#newChatModal").addEventListener("click", (e)=>{ if(e.target.id==="newChatModal") showNewChat(false); });

    $("#startChatBtn").addEventListener("click", ()=> startChatWithEmail($("#newChatEmail").value));
    $("#newChatEmail").addEventListener("keydown", (e)=>{ if(e.key==="Enter") startChatWithEmail($("#newChatEmail").value); });

    $("#copyMyEmailBtn").addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(me?.email || "");
        toast("Kopyalandƒ±");
      }catch{
        toast("Kopyalanamadƒ±");
      }
    });

    $("#back").addEventListener("click", closeChat);
    $("#send").addEventListener("click", sendMsg);
    $("#msg").addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMsg();
      }
    });

    $("#more").addEventListener("click", ()=> showChatMenu(true));
    $("#closeChatMenu").addEventListener("click", ()=> showChatMenu(false));
    $("#chatMenuModal").addEventListener("click", (e)=>{ if(e.target.id==="chatMenuModal") showChatMenu(false); });
    $("#closeChatBtn2").addEventListener("click", ()=>{ showChatMenu(false); closeChat(); });
    $("#clearChatBtn").addEventListener("click", ()=>{
      $("#chatBody").innerHTML = "";
      toast("Bu cihazda temizlendi");
      showChatMenu(false);
    });

    $("#statusAddBtn").addEventListener("click", addStatus);
    $("#statusInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addStatus(); } });

    $("#callInfoBtn").addEventListener("click", ()=>{
      toast("Sesli arama i√ßin native/Capacitor gerekir");
      alert("Sesli arama (WhatsApp gibi) tek HTML dosyada olmaz.\nGerekli: WebRTC + signaling server veya Android native/Capacitor.\nƒ∞stersen sonraki adƒ±mda bunu kurarƒ±z.");
    });

    // Delegation for tabs and list clicks
    document.addEventListener("click", async (e)=>{
      const tab = e.target.closest(".tab");
      if(tab){
        if(!me && tab.dataset.tab !== "profile"){ // profile also needs auth, but show auth anyway
          setTab("auth");
          toast("√ñnce giri≈ü yap");
          return;
        }
        setTab(tab.dataset.tab);
        return;
      }

      const inboxItem = e.target.closest("#chatList .item");
      if(inboxItem){
        const thread = inboxItem.dataset.thread;
        const ouid = inboxItem.dataset.ouid;
        const oname = inboxItem.dataset.oname;
        // fetch other profile for color/online
        let other = { uid: ouid, name: oname, color: uidColor(ouid) };
        try{
          const ps = await get(ref(db, `profiles/${ouid}`));
          if(ps.exists()){
            const pv = ps.val();
            other = { uid: ouid, name: pv.name || pv.email || oname, color: pv.color || uidColor(ouid) };
          }
        }catch{}
        openChat(thread, other);
        return;
      }

      const callItem = e.target.closest("#callsList .item");
      if(callItem){
        toast("Sesli arama: native gerekir");
        alert("Bu s√ºr√ºmde arama demo.\nGer√ßek sesli arama i√ßin Android native/Capacitor kurmak gerekir.");
        return;
      }
    });

    // ===== Auth State =====
    onAuthStateChanged(auth, async (user)=>{
      me = user || null;

      if(!me){
        myProfile = null;
        $("#sub").textContent = "Basit mesajla≈üma";
        setTab("auth");
        $("#addBtn").classList.add("hidden");
        return;
      }

      $("#addBtn").classList.remove("hidden");
      $("#authErr").textContent = "";

      myProfile = await ensureProfile(me);
      paintProfileUI();
      setOnlineSub();

      // Show messages by default
      setTab("messages");
      toast("Giri≈ü ba≈üarƒ±lƒ±");

      // Listen inbox + statuses
      listenInbox();
      listenMyStatuses();
    });

    // Start UI
    setTab("messages");
    $("#sub").textContent = "Giri≈ü yaparak ba≈ülayƒ±n";
  </script>
</body>
</html>
