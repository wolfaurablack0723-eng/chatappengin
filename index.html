<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyA3--Xy1WrM6WlxurXXr4i5qwMZiafXN4k",
  authDomain: "vigochat-58144.firebaseapp.com",
  projectId: "vigochat-58144"
};

firebase.initializeApp(firebaseConfig);
var auth = firebase.auth();
var db = firebase.firestore();

let currentUser = null;
let currentChat = null;

auth.signInAnonymously();

auth.onAuthStateChanged(function(user){
  if(user){
    currentUser = user;
    loadChats();
    loadStatus();
    loadProfile();
  }
});

function loadChats(){
  db.collection("chats")
  .where("users","array-contains",currentUser.uid)
  .onSnapshot(function(snapshot){
    const el = document.getElementById("chatList");
    el.innerHTML = "";
    snapshot.forEach(function(doc){
      const data = doc.data();
      const div = document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div class="avatar">${data.name[0]}</div>
        <div class="meta">
          <b>${data.name}</b>
          <span>${data.last || ""}</span>
        </div>
      `;
      div.onclick = function(){ openChat(doc.id,data.name); };
      el.appendChild(div);
    });
  });
}

function openChat(id,name){
  currentChat = id;
  document.getElementById("chatName").innerText = name;
  document.getElementById("overlay").classList.add("show");

  db.collection("chats").doc(id)
  .collection("messages")
  .orderBy("time")
  .onSnapshot(function(snapshot){
    const box = document.getElementById("chatBody");
    box.innerHTML="";
    snapshot.forEach(function(doc){
      const d = doc.data();
      const div = document.createElement("div");
      div.className="bubble"+(d.uid==currentUser.uid?" me":"");
      div.innerText=d.text;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  });
}

function sendMsg(){
  const msg = document.getElementById("msg").value;
  if(!msg || !currentChat) return;

  db.collection("chats").doc(currentChat)
  .collection("messages")
  .add({
    text: msg,
    uid: currentUser.uid,
    time: Date.now()
  });

  db.collection("chats").doc(currentChat).update({
    last: msg
  });

  document.getElementById("msg").value="";
}

function loadStatus(){
  db.collection("status").onSnapshot(function(snapshot){
    const list = document.querySelector("#view-status .list");
    list.innerHTML="";
    snapshot.forEach(function(doc){
      const d = doc.data();
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <div class="avatar">✨</div>
        <div class="meta">
          <b>${d.name}</b>
          <span>${d.text}</span>
        </div>
      `;
      list.appendChild(div);
    });
  });
}

function loadProfile(){
  db.collection("users").doc(currentUser.uid).get()
  .then(function(doc){
    if(!doc.exists){
      db.collection("users").doc(currentUser.uid).set({
        name:"Kullanıcı",
        about:""
      });
    }
  });
}

document.getElementById("send").onclick = sendMsg;
document.getElementById("back").onclick = function(){
  document.getElementById("overlay").classList.remove("show");
};
</script>
