<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3--Xy1WrM6WlxurXXr4i5qwMZiafXN4k",
  authDomain: "vigochat-58144.firebaseapp.com",
  projectId: "vigochat-58144"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentChatEmail = null;
let currentChatId = null;

/* ---------------- AUTH EKRANI EKLE ---------------- */

const authCard = document.createElement("div");
authCard.className="card";
authCard.innerHTML = `
  <h3>Giriş / Kayıt</h3>
  <input id="emailInput" placeholder="Email">
  <input id="passInput" type="password" placeholder="Şifre">
  <button id="registerBtn">Kayıt Ol</button>
  <button id="loginBtn">Giriş Yap</button>
  <div id="authError" style="color:red"></div>
`;
document.getElementById("view-profile").prepend(authCard);

document.getElementById("registerBtn").onclick = async ()=>{
  try{
    await createUserWithEmailAndPassword(auth,
      emailInput.value, passInput.value);
  }catch(e){
    authError.innerText=e.message;
  }
};

document.getElementById("loginBtn").onclick = async ()=>{
  try{
    await signInWithEmailAndPassword(auth,
      emailInput.value, passInput.value);
  }catch(e){
    authError.innerText=e.message;
  }
};

onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    authCard.style.display="none";
    loadUsers();
  }else{
    authCard.style.display="block";
  }
});

/* ---------------- KULLANICILARI YÜKLE ---------------- */

function loadUsers(){
  const usersRef = collection(db,"users");

  onSnapshot(usersRef,snap=>{
    const list = document.getElementById("chatList");
    list.innerHTML="";

    snap.forEach(doc=>{
      const data=doc.data();
      if(data.email===currentUser.email) return;

      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <div class="avatar">${data.email[0].toUpperCase()}</div>
        <div class="meta">
          <b>${data.email}</b>
          <span>Sohbet aç</span>
        </div>
      `;
      div.onclick=()=>openChat(data.email);
      list.appendChild(div);
    });
  });

  // kullanıcıyı kaydet
  addDoc(usersRef,{
    email:currentUser.email
  });
}

/* ---------------- CHAT ---------------- */

function openChat(targetEmail){
  currentChatEmail=targetEmail;
  currentChatId=[currentUser.email,targetEmail].sort().join("_");

  document.getElementById("overlay").classList.add("show");
  document.getElementById("chatName").innerText=targetEmail;

  listenMessages();
}

function listenMessages(){
  const q=query(
    collection(db,"chats",currentChatId,"messages"),
    orderBy("time")
  );

  onSnapshot(q,snap=>{
    const box=document.getElementById("chatBody");
    box.innerHTML="";

    snap.forEach(doc=>{
      const data=doc.data();
      const div=document.createElement("div");
      div.className="bubble";
      if(data.uid===currentUser.uid) div.classList.add("me");
      div.innerText=data.text;
      box.appendChild(div);
    });

    box.scrollTop=box.scrollHeight;
  });
}

document.getElementById("send").onclick=async ()=>{
  if(!currentChatId) return;
  const text=document.getElementById("msg").value.trim();
  if(!text) return;

  await addDoc(
    collection(db,"chats",currentChatId,"messages"),
    {
      text:text,
      uid:currentUser.uid,
      time:Date.now()
    }
  );

  document.getElementById("msg").value="";
};

</script>
