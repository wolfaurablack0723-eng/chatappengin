<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>VigoChatt</title>
  <style>
    :root{
      --bg:#efe7db;
      --card:rgba(255,255,255,.62);
      --text:#171717;
      --muted:rgba(0,0,0,.55);
      --border:rgba(0,0,0,.10);
      --accent:#2b6cff;
      --accent2:rgba(43,108,255,.12);
      --radius:18px;
      --shadow: 0 14px 30px rgba(0,0,0,.08);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 600px at 60% 10%, rgba(255,255,255,.78), transparent 60%),
        radial-gradient(900px 600px at 10% 90%, rgba(255,255,255,.62), transparent 60%),
        var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    input, textarea { -webkit-user-select:text; user-select:text; }

    .wrap{
      max-width:520px;
      margin:0 auto;
      min-height:100dvh;
      padding-top: var(--safe-top);
      padding-bottom: calc(92px + var(--safe-bottom));
      display:flex;
      flex-direction:column;
    }
    .top{
      padding:16px 16px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .top h1{margin:0;font-size:18px;letter-spacing:.2px}
    .top small{color:var(--muted)}
    .pill{
      border:1px solid var(--border);
      background: var(--card);
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
      appearance:none;-webkit-appearance:none;
      font:inherit;color:inherit;
      box-shadow: 0 10px 22px rgba(0,0,0,.06);
    }

    .card{
      margin:0 16px 12px;
      border:1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }
    .hint{margin-top:8px; font-size:12px; color:var(--muted)}
    .danger{color:#b42318}
    .ok{color:#067647}

    .label{font-size:12px; font-weight:900; color:var(--muted); letter-spacing:.2px}
    input, textarea{
      width:100%;
      border:1px solid var(--border);
      background: rgba(255,255,255,.82);
      border-radius: 16px;
      padding:12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:44px; max-height:140px; resize:none}

    .btn{
      border:1px solid rgba(43,108,255,.24);
      background: var(--accent2);
      color: var(--accent);
      border-radius: 16px;
      padding: 12px 14px;
      font-weight:900;
      cursor:pointer;
      appearance:none;-webkit-appearance:none;
      font:inherit;
      user-select:none;
    }

    .view{display:none; flex:1; overflow:auto; padding-bottom:12px}
    .view.active{display:block}

    .list{margin:0 16px; display:flex; flex-direction:column; gap:10px}
    .item{
      display:flex; gap:12px; align-items:center;
      border:1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      cursor:pointer;
      user-select:none;
    }
    .avatar{
      width:44px;height:44px;border-radius:16px;
      background: var(--accent2);
      border:1px solid rgba(43,108,255,.18);
      display:grid; place-items:center;
      flex:0 0 auto;
      font-weight:900;
      color:var(--accent);
    }
    .meta{min-width:0; flex:1}
    .meta b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta span{display:block; font-size:13px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:3px}

    /* Chat overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none;
      z-index: 50;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }
    .overlay.show{display:block}
    .chat{
      max-width:520px;
      margin:0 auto;
      height:100%;
      display:flex;
      flex-direction:column;
      background: rgba(255,255,255,.56);
    }
    .chatTop{
      padding: 12px 14px;
      display:flex; align-items:center; gap:10px;
      border-bottom:1px solid var(--border);
      background: var(--card);
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    .iconBtn{
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.82);
      cursor:pointer;
      display:grid; place-items:center;
      appearance:none;-webkit-appearance:none;
      font:inherit;color:inherit;
      user-select:none;
      padding:0;
    }
    .chatTitle{min-width:0; flex:1}
    .chatTitle b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .chatTitle span{display:block; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .chatBody{
      flex:1;
      overflow:auto;
      padding: 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubble{
      max-width:82%;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.86);
      font-size:14px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    .bubble.me{
      margin-left:auto;
      background: var(--accent2);
      border-color: rgba(43,108,255,.20);
    }
    .composer{
      position: sticky;
      bottom: 0;
      padding: 10px 14px calc(10px + var(--safe-bottom));
      border-top:1px solid var(--border);
      background: var(--card);
      display:flex;
      gap:10px;
      align-items:flex-end;
      box-shadow: 0 -10px 24px rgba(0,0,0,.06);
    }
    .send{
      width:52px;height:52px;border-radius:16px;
      border:1px solid rgba(43,108,255,.24);
      background: var(--accent2);
      color: var(--accent);
      font-weight:900;
      cursor:pointer;
      appearance:none;-webkit-appearance:none;
      font:inherit;
      user-select:none;
      display:grid;place-items:center;
      padding:0;
    }

    /* Bottom nav */
    .bottom{
      position:fixed; left:0; right:0; bottom:0;
      z-index:9999;
      padding: 10px 12px calc(10px + var(--safe-bottom));
      display:flex; justify-content:center;
    }
    .nav{
      width:min(520px, calc(100% - 24px));
      border:1px solid var(--border);
      background: var(--card);
      border-radius: 22px;
      padding: 10px;
      display:flex;
      gap:8px;
      box-shadow: var(--shadow);
    }
    .tabBtn{
      flex:1;
      border-radius: 16px;
      padding: 10px 6px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
      color:var(--muted);
      border:1px solid transparent;
      background: transparent;
      appearance:none;-webkit-appearance:none;
      font:inherit;
    }
    .tabBtn.active{
      color: var(--text);
      background: var(--accent2);
      border-color: rgba(43,108,255,.18);
    }
    .tabBtn .ico{font-size:20px; line-height:1}
    .tabBtn .lbl{font-size:12px; font-weight:900}
  </style>

  <!-- ‚úÖ MODULE YOK: compat -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 id="title">VigoChatt</h1>
        <small id="sub">A√ßƒ±lƒ±yor‚Ä¶</small>
      </div>
      <button class="pill" id="logoutBtn" type="button" style="display:none">√áƒ±kƒ±≈ü</button>
    </div>

    <!-- AUTH -->
    <section class="view active" id="view-auth">
      <div class="card">
        <b>Giri≈ü / Kayƒ±t</b>
        <div class="hint">Firebase: <span id="fbState">y√ºkleniyor‚Ä¶</span></div>

        <div style="margin-top:12px">
          <div class="label">E-posta</div>
          <input id="email" inputmode="email" autocomplete="email" placeholder="ornek@mail.com">

          <div class="label" style="margin-top:10px">≈ûifre</div>
          <input id="pass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

          <div style="display:flex; gap:10px; margin-top:12px">
            <button class="btn" id="loginBtn" type="button" style="flex:1">Giri≈ü</button>
            <button class="btn" id="signupBtn" type="button" style="flex:1">Kayƒ±t</button>
          </div>

          <div class="hint danger" id="authErr"></div>
        </div>
      </div>
    </section>

    <!-- CHATS -->
    <section class="view" id="view-chats">
      <div class="card">
        <b>Sohbetler</b>
        <div class="hint" id="mustLoginChats"></div>

        <div style="margin-top:12px">
          <div class="label">Kar≈üƒ± taraf email</div>
          <div style="display:flex; gap:10px; margin-top:8px">
            <input id="startEmail" inputmode="email" autocomplete="off" placeholder="arkadas@mail.com" style="flex:1">
            <button class="btn" id="startBtn" type="button">Ba≈ülat</button>
          </div>
          <div class="hint danger" id="startErr"></div>
        </div>
      </div>

      <div class="list" id="threadList"></div>
    </section>

    <!-- STATUS -->
    <section class="view" id="view-status">
      <div class="card">
        <b>Durum</b>
        <div class="hint" id="mustLoginStatus"></div>

        <div style="margin-top:12px">
          <div class="label">Durum</div>
          <input id="about" placeholder="√ßevrimi√ßi">
          <button class="btn" id="saveAbout" type="button" style="margin-top:10px">Kaydet</button>
          <div class="hint" id="aboutHint"></div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="view" id="view-settings">
      <div class="card">
        <b>Ayarlar</b>
        <div class="hint" id="mustLoginSettings"></div>

        <div style="margin-top:12px">
          <div class="label">Ad Soyad</div>
          <input id="name" placeholder="Engin">
          <button class="btn" id="saveProfile" type="button" style="margin-top:10px">Kaydet</button>
          <div class="hint" id="saveHint"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- CHAT -->
  <div class="overlay" id="overlay">
    <div class="chat">
      <div class="chatTop">
        <button class="iconBtn" id="back" type="button">‚Üê</button>
        <div class="chatTitle">
          <b id="chatName">Sohbet</b>
          <span id="chatSub">online</span>
        </div>
        <button class="iconBtn" id="chatMore" type="button">‚ãØ</button>
      </div>

      <div class="chatBody" id="chatBody"></div>

      <div class="composer">
        <textarea id="msg" rows="1" placeholder="Mesaj yaz‚Ä¶"></textarea>
        <button class="send" id="send" type="button">‚û§</button>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <div class="bottom">
    <nav class="nav">
      <button class="tabBtn active" type="button" data-tab="auth"><div class="ico">üîê</div><div class="lbl">Giri≈ü</div></button>
      <button class="tabBtn" type="button" data-tab="chats"><div class="ico">üí¨</div><div class="lbl">Sohbet</div></button>
      <button class="tabBtn" type="button" data-tab="status"><div class="ico">‚ú®</div><div class="lbl">Durum</div></button>
      <button class="tabBtn" type="button" data-tab="settings"><div class="ico">‚öôÔ∏è</div><div class="lbl">Ayarlar</div></button>
    </nav>
  </div>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script>
    // ---- helpers
    const $ = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
    const esc = (s)=> String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));

    function setView(id){
      ["auth","chats","status","settings"].forEach(v=>{
        $("#view-"+v).classList.toggle("active", v===id);
      });
      $$(".tabBtn").forEach(t=> t.classList.toggle("active", t.dataset.tab===id));
      const titles = {auth:"Giri≈ü", chats:"Sohbetler", status:"Durum", settings:"Ayarlar"};
      $("#title").textContent = titles[id] || "VigoChatt";
    }

    // ‚úÖ Sekmeler HEP √ßalƒ±≈üƒ±r (giri≈ü olsun olmasƒ±n)
    $$(".tabBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        setView(btn.dataset.tab);
        renderMustLoginHints();
      });
    });

    function autoGrow(ta){
      ta.style.height = "auto";
      ta.style.height = Math.min(140, ta.scrollHeight) + "px";
    }

    const state = {
      uid: null,
      email: "",
      name: "Kullanƒ±cƒ±",
      db: null
    };

    function renderMustLoginHints(){
      const msg = state.uid ? "" : "Giri≈ü yapmadan bu sayfa sadece g√∂r√ºnt√ºlenir. ƒ∞≈ülem i√ßin giri≈ü yap.";
      $("#mustLoginChats").textContent = msg;
      $("#mustLoginStatus").textContent = msg;
      $("#mustLoginSettings").textContent = msg;
      $("#logoutBtn").style.display = state.uid ? "inline-block" : "none";
    }

    // ---- Firebase init (compat)
    function initFirebaseWhenReady(){
      // firebase scriptleri y√ºklenmeden √ßalƒ±≈ütƒ±rmayalƒ±m
      if(!window.firebase || !firebase.apps){
        setTimeout(initFirebaseWhenReady, 60);
        return;
      }

      try{
  firebase.initializeApp({
    apiKey: "AIzaSyA3--Xy1WrM6WlxurXXr4i5qwMZiafXN4k",
    authDomain: "vigochat-58144.firebaseapp.com",
    databaseURL: "https://vigochat-58144-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "vigochat-58144",
    storageBucket: "vigochat-58144.firebasestorage.app",
    messagingSenderId: "384136632816",
    appId: "1:384136632816:web:2bb6d6942680a2e2e6e535",
    measurementId: "G-62VZ3906GS"
  });

        $("#fbState").textContent = "OK ‚úÖ";
        $("#fbState").className = "ok";
        $("#sub").textContent = "Hazƒ±r";

        const auth = firebase.auth();
        state.db = firebase.firestore();

        auth.onAuthStateChanged(async (user)=>{
          if(!user){
            state.uid = null;
            state.email = "";
            $("#sub").textContent = "Giri≈ü gerekli";
            renderMustLoginHints();
            return;
          }
          state.uid = user.uid;
          state.email = user.email || "";
          $("#sub").textContent = "Online ‚úÖ";
          renderMustLoginHints();
          await ensureUserDoc();
          // giri≈ü olunca otomatik sohbetlere ge√ß
          setView("chats");
        });

        // buttons
        $("#loginBtn").addEventListener("click", login);
        $("#signupBtn").addEventListener("click", signup);
        $("#logoutBtn").addEventListener("click", ()=> auth.signOut());

        $("#saveProfile").addEventListener("click", saveProfile);
        $("#saveAbout").addEventListener("click", saveAbout);
        $("#startBtn").addEventListener("click", startChat);

        $("#msg").addEventListener("input", (e)=> autoGrow(e.target));
        $("#send").addEventListener("click", sendMsg);
        $("#msg").addEventListener("keydown", (e)=>{
          if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMsg(); }
        });

        $("#back").addEventListener("click", closeChat);

      }catch(e){
        console.log(e);
        $("#fbState").textContent = "HATA ‚ùå";
        $("#fbState").className = "danger";
        $("#authErr").textContent = "Firebase ba≈ülatƒ±lamadƒ±. Auth/Firestore ayarlarƒ±nƒ± kontrol et.";
      }
    }

    async function login(){
      $("#authErr").textContent = "";
      const email = ($("#email").value||"").trim();
      const pass = ($("#pass").value||"").trim();
      try{
        await firebase.auth().signInWithEmailAndPassword(email, pass);
      }catch(e){
        $("#authErr").textContent = e.message || "Giri≈ü hatasƒ±";
      }
    }

    async function signup(){
      $("#authErr").textContent = "";
      const email = ($("#email").value||"").trim();
      const pass = ($("#pass").value||"").trim();
      try{
        await firebase.auth().createUserWithEmailAndPassword(email, pass);
      }catch(e){
        $("#authErr").textContent = e.message || "Kayƒ±t hatasƒ±";
      }
    }

    async function ensureUserDoc(){
      const ref = state.db.collection("users").doc(state.uid);
      const snap = await ref.get();
      if(!snap.exists){
        await ref.set({
          email: state.email,
          name: "Kullanƒ±cƒ±",
          about: "√ßevrimi√ßi",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      const s2 = await ref.get();
      const d = s2.data() || {};
      state.name = d.name || "Kullanƒ±cƒ±";
      $("#name").value = state.name;
      $("#about").value = d.about || "√ßevrimi√ßi";
    }

    function threadIdFor(a,b){ return (a<b) ? (a+"_"+b) : (b+"_"+a); }

    async function startChat(){
      $("#startErr").textContent = "";
      if(!state.uid){ $("#startErr").textContent = "√ñnce giri≈ü yap."; return; }

      const email = ($("#startEmail").value||"").trim().toLowerCase();
      if(!email) return;
      if(email === (state.email||"").toLowerCase()){
        $("#startErr").textContent = "Kendi email‚Äôinle sohbet a√ßamazsƒ±n.";
        return;
      }

      const usersSnap = await state.db.collection("users").where("email","==", email).get();
      if(usersSnap.empty){
        $("#startErr").textContent = "Bu email ile kayƒ±tlƒ± kullanƒ±cƒ± yok.";
        return;
      }
      const otherDoc = usersSnap.docs[0];
      const otherUid = otherDoc.id;
      const other = otherDoc.data() || {};

      const tid = threadIdFor(state.uid, otherUid);
      const tRef = state.db.collection("threads").doc(tid);
      const tSnap = await tRef.get();

      if(!tSnap.exists){
        await tRef.set({
          participants: [state.uid, otherUid],
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastText: "",
          a: { uid: state.uid, name: state.name },
          b: { uid: otherUid, name: other.name || "Kullanƒ±cƒ±" }
        });
      }

      $("#startEmail").value = "";
      subscribeThreadList();
      openThread(tid);
    }

    let unsubThreads = null;
    function subscribeThreadList(){
      if(!state.uid) return;
      if(unsubThreads) unsubThreads();

      unsubThreads = state.db.collection("threads")
        .orderBy("updatedAt","desc")
        .limit(50)
        .onSnapshot((snap)=>{
          const list = [];
          snap.forEach(d=>{
            const t = d.data();
            if(Array.isArray(t.participants) && t.participants.includes(state.uid)){
              list.push({id:d.id, ...t});
            }
          });
          renderThreads(list);
        });
    }

    function renderThreads(list){
      const el = $("#threadList");
      el.innerHTML = list.map(t=>{
        const other = (t.a?.uid === state.uid) ? t.b : t.a;
        const name = other?.name || "Kullanƒ±cƒ±";
        const last = t.lastText || "Sohbete gir‚Ä¶";
        return `
          <div class="item" data-thread="${esc(t.id)}">
            <div class="avatar">${esc((name[0]||"üôÇ"))}</div>
            <div class="meta">
              <b>${esc(name)}</b>
              <span>${esc(last)}</span>
            </div>
          </div>
        `;
      }).join("");

      $$("#threadList .item").forEach(it=>{
        it.addEventListener("click", ()=> openThread(it.dataset.thread));
      });
    }

    let currentThread = null;
    let unsubMsgs = null;

    function openThread(tid){
      currentThread = tid;
      $("#overlay").classList.add("show");
      $("#chatName").textContent = "Sohbet";
      $("#chatSub").textContent = "online";

      if(unsubMsgs) unsubMsgs();
     unsubMsgs  = stat
      if(unsubMsgs) unsubMsgs();

unsubMsgs = state.db.collection("threads").doc(tid)
  .collection("messages")
  .orderBy("createdAt","asc")
  .limit(300)
  .onSnapshot((snap)=>{
    const arr = [];
    snap.forEach(d=> arr.push(d.data()));
    renderMsgs(arr);
  });
}

function closeChat(){
  $("#overlay").classList.remove("show");
  $("#msg").value = "";
  if(unsubMsgs) unsubMsgs();
  unsubMsgs = null;
  currentThread = null;
}

function renderMsgs(arr){
  const box = $("#chatBody");
  box.innerHTML = arr.map(m=>{
    const mine = (m.uid === state.uid);
    return `<div class="bubble ${mine ? "me":""}">${esc(m.text || "")}</div>`;
  }).join("");
  box.scrollTop = box.scrollHeight;
}

async function sendMsg(){
  if(!state.uid) return alert("√ñnce giri≈ü yap.");
  if(!currentThread) return;

  const text = ($("#msg").value||"").trim();
  if(!text) return;
  $("#msg").value = "";
  autoGrow($("#msg"));

  await state.db.collection("threads").doc(currentThread)
    .collection("messages").add({
      uid: state.uid,
      text: text.slice(0,2000),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  await state.db.collection("threads").doc(currentThread).update({
    lastText: text.slice(0,120),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).catch(()=>{});
}

async function saveAbout(){
  if(!state.uid){ $("#aboutHint").textContent = "√ñnce giri≈ü yap."; return; }
  $("#aboutHint").textContent = "Kaydediliyor‚Ä¶";
  const about = ($("#about").value||"").trim().slice(0,80) || "√ßevrimi√ßi";
  await state.db.collection("users").doc(state.uid).update({ about });
  $("#aboutHint").textContent = "Kaydedildi ‚úÖ";
  setTimeout(()=> $("#aboutHint").textContent="", 1200);
}

async function saveProfile(){
  if(!state.uid){ $("#saveHint").textContent = "√ñnce giri≈ü yap."; return; }
  $("#saveHint").textContent = "Kaydediliyor‚Ä¶";
  const name = ($("#name").value||"").trim().slice(0,40) || "Kullanƒ±cƒ±";
  await state.db.collection("users").doc(state.uid).update({ name });
  state.name = name;
  $("#saveHint").textContent = "Kaydedildi ‚úÖ";
  setTimeout(()=> $("#saveHint").textContent="", 1200);
}

setView("auth");
renderMustLoginHints();
initFirebaseWhenReady();
</script>
  
</body>
</html>
  
