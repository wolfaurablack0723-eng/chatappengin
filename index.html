<script>
const firebaseConfig = {
  apiKey: "AIzaSyA3--Xy1WrM6WlxurXXr4i5qwMZiafXN4k",
  authDomain: "vigochat-58144.firebaseapp.com",
  projectId: "vigochat-58144",
};

let app, db, auth, userId = null;
let currentRoom = null;

const chatList = document.getElementById("chatList");
const chatBody = document.getElementById("chatBody");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const overlay = document.getElementById("overlay");
const backBtn = document.getElementById("back");

function initFirebase() {
  const s1 = document.createElement("script");
  s1.src = "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";
  document.body.appendChild(s1);

  s1.onload = () => {
    const s2 = document.createElement("script");
    s2.src = "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js";
    document.body.appendChild(s2);

    const s3 = document.createElement("script");
    s3.src = "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js";
    document.body.appendChild(s3);

    s3.onload = startApp;
  };
}

function startApp() {
  app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();

  auth.signInAnonymously().then((res)=>{
    userId = res.user.uid;
    loadRooms();
  }).catch(()=> {
    console.log("Auth hatası ama görüntü var");
  });
}

function loadRooms() {
  chatList.innerHTML = "";

  db.collection("rooms").get().then((snapshot)=>{
    snapshot.forEach(doc=>{
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="avatar">${data.name[0]}</div>
        <div class="meta">
          <b>${data.name}</b>
          <span>Sohbete gir</span>
        </div>
      `;
      div.onclick = ()=> openChat(doc.id, data.name);
      chatList.appendChild(div);
    });
  });
}

function openChat(roomId, name){
  currentRoom = roomId;
  document.getElementById("chatName").textContent = name;
  overlay.classList.add("show");

  db.collection("rooms")
    .doc(roomId)
    .collection("messages")
    .orderBy("createdAt")
    .onSnapshot((snapshot)=>{
      chatBody.innerHTML = "";
      snapshot.forEach(doc=>{
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "bubble " + (data.uid === userId ? "me":"");
        div.textContent = data.text;
        chatBody.appendChild(div);
      });
      chatBody.scrollTop = chatBody.scrollHeight;
    });
}

sendBtn.onclick = ()=>{
  const text = msgInput.value.trim();
  if(!text || !currentRoom) return;

  db.collection("rooms")
    .doc(currentRoom)
    .collection("messages")
    .add({
      text: text,
      uid: userId,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

  msgInput.value = "";
};

backBtn.onclick = ()=>{
  overlay.classList.remove("show");
  currentRoom = null;
};

initFirebase();
</script>
