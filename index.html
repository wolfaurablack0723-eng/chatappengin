<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot,
  serverTimestamp,
  doc,
  setDoc,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3--Xy1WrM6WlxurXXr4i5qwMZiafXN4k",
  authDomain: "vigochat-58144.firebaseapp.com",
  projectId: "vigochat-58144",
  storageBucket: "vigochat-58144.firebasestorage.app",
  messagingSenderId: "384136632816",
  appId: "1:384136632816:web:2bb6d6942680a2e2e6e535"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userId = null;
let currentRoom = null;

signInAnonymously(auth);

onAuthStateChanged(auth, (user)=>{
  if(user){
    userId = user.uid;
    loadRooms();
  }
});

const chatList = document.getElementById("chatList");
const chatBody = document.getElementById("chatBody");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const overlay = document.getElementById("overlay");
const backBtn = document.getElementById("back");

async function loadRooms(){
  chatList.innerHTML = "";

  const snapshot = await getDocs(collection(db,"rooms"));

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="avatar">${data.name[0]}</div>
      <div class="meta">
        <b>${data.name}</b>
        <span>Sohbete gir</span>
      </div>
    `;
    div.onclick = ()=> openChat(docSnap.id, data.name);
    chatList.appendChild(div);
  });
}

function openChat(roomId, name){
  currentRoom = roomId;
  document.getElementById("chatName").textContent = name;
  overlay.classList.add("show");
  loadMessages(roomId);
}

function loadMessages(roomId){
  const q = query(
    collection(db,"rooms",roomId,"messages"),
    orderBy("createdAt")
  );

  onSnapshot(q, (snapshot)=>{
    chatBody.innerHTML = "";
    snapshot.forEach(doc=>{
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "bubble " + (data.uid === userId ? "me":"");
      div.textContent = data.text;
      chatBody.appendChild(div);
    });
    chatBody.scrollTop = chatBody.scrollHeight;
  });
}

sendBtn.onclick = async ()=>{
  const text = msgInput.value.trim();
  if(!text || !currentRoom) return;

  await addDoc(
    collection(db,"rooms",currentRoom,"messages"),
    {
      text: text,
      uid: userId,
      createdAt: serverTimestamp()
    }
  );

  msgInput.value = "";
};

backBtn.onclick = ()=>{
  overlay.classList.remove("show");
  currentRoom = null;
};
</script>
