<!-- Firebase Compat -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyA3--Xy1WrM6WlxurXXr4i5qwMZiafXN4k",
  authDomain: "vigochat-58144.firebaseapp.com",
  databaseURL: "https://vigochat-58144-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "vigochat-58144",
  storageBucket: "vigochat-58144.firebasestorage.app",
  messagingSenderId: "384136632816",
  appId: "1:384136632816:web:2bb6d6942680a2e2e6e535"
};

firebase.initializeApp(firebaseConfig);
var db = firebase.database();

let currentUser = null;
let currentChat = null;

function login(){
  let phone = prompt("Numara gir");
  if(!phone) return;
  currentUser = phone;

  db.ref("users/"+phone).set({
    phone: phone,
    online: true
  });

  loadUsers();
}

function loadUsers(){
  db.ref("users").on("value", snap=>{
    const data = snap.val() || {};
    const el = document.getElementById("chatList");
    el.innerHTML="";
    Object.keys(data).forEach(uid=>{
      if(uid===currentUser) return;
      el.innerHTML+=`
        <div class="item" onclick="openChat('${uid}')">
          <div class="avatar">${uid[0]}</div>
          <div class="meta">
            <b>${uid}</b>
            <span>Mesajla≈ü</span>
          </div>
        </div>
      `;
    });
  });
}

function chatId(a,b){
  return a<b ? a+"_"+b : b+"_"+a;
}

function openChat(uid){
  currentChat = uid;
  document.getElementById("chatName").innerText = uid;
  document.getElementById("overlay").classList.add("show");
  loadMessages();
}

function loadMessages(){
  let id = chatId(currentUser,currentChat);
  db.ref("messages/"+id).on("value", snap=>{
    const data = snap.val() || {};
    const box = document.getElementById("chatBody");
    box.innerHTML="";
    Object.values(data).forEach(m=>{
      box.innerHTML+=`
        <div class="bubble ${m.from===currentUser?'me':''}">
          ${m.text}
        </div>
      `;
    });
    box.scrollTop = box.scrollHeight;
  });
}

function sendMsg(){
  let text = document.getElementById("msg").value.trim();
  if(!text) return;
  let id = chatId(currentUser,currentChat);
  db.ref("messages/"+id).push({
    from: currentUser,
    text: text,
    time: Date.now()
  });
  document.getElementById("msg").value="";
}

function closeChat(){
  document.getElementById("overlay").classList.remove("show");
}

</script>
