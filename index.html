<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>VigoChatt</title>
  <style>
    :root{
      --bg:#efe7db;
      --card:rgba(255,255,255,.58);
      --text:#1b1b1b;
      --muted:rgba(0,0,0,.55);
      --border:rgba(0,0,0,.10);
      --accent:#2b6cff;
      --accent2:rgba(43,108,255,.12);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --radius:18px;
      --shadow: 0 12px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 600px at 60% 10%, rgba(255,255,255,.75), transparent 60%),
        radial-gradient(900px 600px at 10% 90%, rgba(255,255,255,.60), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    .app{
      max-width:520px;
      margin:0 auto;
      min-height:100dvh;
      display:flex;
      flex-direction:column;
      padding-top: var(--safe-top);
      padding-bottom: calc(84px + var(--safe-bottom));
    }

    /* Header */
    .header{
      padding:16px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .header h1{margin:0;font-size:18px;letter-spacing:.2px}
    .header small{color:var(--muted)}
    .pill{
      border:1px solid var(--border);
      background: var(--card);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      appearance:none;-webkit-appearance:none;
      font:inherit;color:inherit;
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
    }
    .pill:active{transform:scale(.98)}

    /* Views */
    .view{
      display:none;
      padding: 6px 16px 16px;
      overflow:auto;
      flex:1;
    }
    .view.active{display:block}

    .card{
      border:1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
    }

    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      display:flex; align-items:center; gap:12px;
      border:1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      padding: 12px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    .item:active{transform:scale(.99)}
    .avatar{
      width:44px;height:44px;border-radius:16px;
      background: var(--accent2);
      border:1px solid rgba(43,108,255,.18);
      display:grid; place-items:center;
      font-weight:900;
      color:var(--accent);
      flex:0 0 auto;
    }
    .meta{min-width:0; flex:1}
    .meta b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta span{display:block; font-size:13px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:3px}

    /* Forms */
    .field{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .label{font-size:12px; color:var(--muted); font-weight:800; letter-spacing:.2px}
    .input, .textarea{
      border:1px solid var(--border);
      background: rgba(255,255,255,.72);
      border-radius: 16px;
      padding: 12px;
      outline:none;
      font-size:14px;
      width:100%;
    }
    .textarea{min-height:90px; resize:none}

    .btnPrimary{
      border:1px solid rgba(43,108,255,.25);
      background: var(--accent2);
      color: var(--accent);
      font-weight:900;
      border-radius: 16px;
      padding: 12px 14px;
      cursor:pointer;
      appearance:none;-webkit-appearance:none;
      font:inherit;
    }
    .btnPrimary:active{transform:scale(.99)}

    /* Chat overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.15);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display:none;
      z-index: 50;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }
    .overlay.show{display:block}

    .chat{
      max-width:520px;
      margin:0 auto;
      height:100%;
      display:flex;
      flex-direction:column;
      background: rgba(255,255,255,.54);
    }
    .chatTop{
      padding: 12px 14px;
      display:flex; align-items:center; gap:10px;
      border-bottom:1px solid var(--border);
      background: var(--card);
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    .btn{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.72);
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
      appearance:none;-webkit-appearance:none;
      font:inherit;color:inherit;
    }
    .btn:active{transform:scale(.98)}
    .chatTitle{min-width:0; flex:1}
    .chatTitle b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .chatTitle span{display:block; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .chatBody{
      flex:1;
      overflow:auto;
      padding: 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      scroll-behavior:smooth;
    }
    .bubble{
      max-width:80%;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.80);
      font-size:14px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
    }
    .bubble.me{
      margin-left:auto;
      background: var(--accent2);
      border-color: rgba(43,108,255,.20);
    }
    .bubbleMeta{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }

    /* IMPORTANT: composer artƒ±k fixed deƒüil, chat i√ßinde sticky */
    .composer{
      position: sticky;
      bottom: 0;
      padding: 10px 14px calc(10px + var(--safe-bottom));
      border-top:1px solid var(--border);
      background: var(--card);
      display:flex;
      gap:10px;
      align-items:flex-end;
      box-shadow: 0 -10px 24px rgba(0,0,0,.06);
    }
    .composer textarea{
      flex:1;
      min-height:44px;
      max-height:140px;
      resize:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.80);
      border-radius: 16px;
      padding: 12px;
      outline:none;
      font-size:14px;
    }
    .send{
      width:52px;height:52px;
      border-radius:16px;
      border:1px solid rgba(43,108,255,.25);
      background: var(--accent2);
      color: var(--accent);
      font-weight:900;
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
      appearance:none;-webkit-appearance:none;
      font:inherit;
    }
    .send:active{transform:scale(.98)}

    /* Bottom bar */
    .bottom{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:9999;
      padding: 10px 12px calc(10px + var(--safe-bottom));
      display:flex;
      justify-content:center;
    }
    .nav{
      width:min(520px, calc(100% - 24px));
      border:1px solid var(--border);
      background: var(--card);
      border-radius: 22px;
      padding: 10px;
      display:flex;
      gap:8px;
      box-shadow: var(--shadow);
    }
    .tab{
      flex:1;
      border-radius: 16px;
      padding: 10px 6px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
      color:var(--muted);
      border:1px solid transparent;
    }
    .tab.active{
      color: var(--text);
      background: var(--accent2);
      border-color: rgba(43,108,255,.18);
    }
    .tab .ico{font-size:20px; line-height:1}
    .tab .lbl{font-size:12px; font-weight:900}
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <div>
        <h1 id="title">Mesajlar</h1>
        <small id="sub">Baƒülanƒ±yor‚Ä¶</small>
      </div>
      <button class="pill" id="addBtn" type="button">Ayarlar</button>
    </div>

    <!-- Aramalar -->
    <section class="view" id="view-calls">
      <div class="card">
        <b>Aramalar</b>
        <div style="margin-top:6px; color:var(--muted); font-size:13px">
          Son aramalar burada g√∂r√ºnecek (demo).
        </div>
      </div>
      <div class="list">
        <div class="item"><div class="avatar">üë§</div><div class="meta"><b>Ahmet</b><span>Bug√ºn 12:05 ‚Ä¢ Gelen</span></div></div>
        <div class="item"><div class="avatar">üë§</div><div class="meta"><b>Zeynep</b><span>D√ºn 21:18 ‚Ä¢ Giden</span></div></div>
      </div>
    </section>

    <!-- Durum -->
    <section class="view" id="view-status">
      <div class="card">
        <b>Durum</b>
        <div style="margin-top:6px; color:var(--muted); font-size:13px">
          Durum payla≈ü ‚Äî herkes g√∂rs√ºn.
        </div>

        <div class="field">
          <div class="label">Yeni durum</div>
          <textarea class="textarea" id="statusText" placeholder="Bir ≈üey yaz‚Ä¶ (√∂rn: Dƒ±≈üarƒ±dayƒ±m)"></textarea>
          <button class="btnPrimary" id="statusSend" type="button">Durum Payla≈ü</button>
          <div style="margin-top:4px; font-size:12px; color:var(--muted)" id="statusHint"></div>
        </div>
      </div>

      <div class="list" id="statusList"></div>
    </section>

    <!-- Mesajlar -->
    <section class="view active" id="view-messages">
      <div class="card">
        <b>Mesajlar</b>
        <div style="margin-top:6px; color:var(--muted); font-size:13px">
          Bir sohbet se√ß ‚Äî ger√ßek zamanlƒ± mesajla≈ü.
        </div>
        <div style="margin-top:8px; font-size:12px; color:var(--muted)">
          <b id="meNickLabel"></b> ‚Ä¢ <span id="meAboutLabel"></span>
        </div>
      </div>
      <div class="list" id="chatList"></div>
    </section>

    <!-- Profil / Ayarlar -->
    <section class="view" id="view-profile">
      <div class="card">
        <b>Ayarlar</b>
        <div style="margin-top:6px; color:var(--muted); font-size:13px">
          Takma ad ve durum mesajƒ±nƒ± kaydet.
        </div>

        <div class="field">
          <div class="label">Takma ad</div>
          <input class="input" id="nickInput" placeholder="√∂rn: Engin"/>
        </div>

        <div class="field">
          <div class="label">Durum mesajƒ±</div>
          <input class="input" id="aboutInput" placeholder="√∂rn: √ßevrimi√ßi"/>
        </div>

        <div class="field">
          <button class="btnPrimary" id="saveSettings" type="button">Kaydet</button>
          <div style="margin-top:6px; font-size:12px; color:var(--muted)" id="saveHint"></div>
        </div>
      </div>

      <div class="card">
        <b>Bilgi</b>
        <div style="margin-top:6px; color:var(--muted); font-size:13px">
          Mesajlar Firebase ile ger√ßek zamanlƒ±dƒ±r.
        </div>
      </div>
    </section>
  </div>

  <!-- Chat overlay -->
  <div class="overlay" id="overlay">
    <div class="chat" id="chatRoot">
      <div class="chatTop">
        <button class="btn" id="back" type="button">‚Üê</button>
        <div class="chatTitle">
          <b id="chatName">Sohbet</b>
          <span id="chatSub">√ßevrimi√ßi</span>
        </div>
        <button class="btn" id="more" type="button">‚ãØ</button>
      </div>

      <div class="chatBody" id="chatBody"></div>

      <div class="composer">
        <textarea id="msg" rows="1" placeholder="Mesaj yaz‚Ä¶"></textarea>
        <button class="send" id="send" type="button">‚û§</button>
      </div>
    </div>
  </div>

  <!-- Bottom nav -->
  <div class="bottom">
    <nav class="nav">
      <div class="tab" data-tab="calls"><div class="ico">üìû</div><div class="lbl">Aramalar</div></div>
      <div class="tab" data-tab="status"><div class="ico">‚ú®</div><div class="lbl">Durum</div></div>
      <div class="tab active" data-tab="messages"><div class="ico">üí¨</div><div class="lbl">Mesajlar</div></div>
      <div class="tab" data-tab="profile"><div class="ico">‚öôÔ∏è</div><div class="lbl">Ayarlar</div></div>
    </nav>
  </div>

  <script type="module">
    const $ = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB1qovN4BNfaFlvE-KvURhX31AshxLuc0",
      authDomain: "vigochatt.firebaseapp.com",
      projectId: "vigochatt",
      storageBucket: "vigochatt.firebasestorage.app",
      messagingSenderId: "12259504636",
      appId: "1:12259504636:web:d6ee79daceac8834d70279"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function esc(s){
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // ---- Settings (local)
    const state = {
      uid: null,
      nick: (localStorage.getItem("vigo_nick") || "Engin").trim() || "Engin",
      about: (localStorage.getItem("vigo_about") || "√ßevrimi√ßi").trim() || "√ßevrimi√ßi",
    };

    function applySettingsToUI(){
      $("#meNickLabel").textContent = state.nick;
      $("#meAboutLabel").textContent = state.about;
      $("#nickInput").value = state.nick;
      $("#aboutInput").value = state.about;
    }

    function saveSettings(){
      state.nick = ($("#nickInput").value || "Engin").trim().slice(0,24) || "Engin";
      state.about = ($("#aboutInput").value || "√ßevrimi√ßi").trim().slice(0,48) || "√ßevrimi√ßi";
      localStorage.setItem("vigo_nick", state.nick);
      localStorage.setItem("vigo_about", state.about);
      applySettingsToUI();
      $("#saveHint").textContent = "Kaydedildi ‚úÖ";
      setTimeout(()=> $("#saveHint").textContent="", 1500);
    }

    // ---- Chats UI list (room ids)
    const chats = [
      {id:"c1", name:"Ahmet", last:""},
      {id:"c2", name:"Zeynep", last:""},
      {id:"c3", name:"Mert", last:""}
    ];

    function renderChats(){
      const el = $("#chatList");
      el.innerHTML = chats.map(c=>`
        <div class="item" data-chat="${c.id}">
          <div class="avatar">${esc((c.name[0]||"‚Ä¢"))}</div>
          <div class="meta">
            <b>${esc(c.name)}</b>
            <span>${esc(c.last || "Sohbete gir‚Ä¶")}</span>
          </div>
        </div>
      `).join("");
    }

    // ---- Tabs
    function setTab(tab){
      $$(".tab").forEach(t=> t.classList.toggle("active", t.dataset.tab === tab));
      ["calls","status","messages","profile"].forEach(v=>{
        const view = $("#view-" + v);
        if(view) view.classList.toggle("active", v === tab);
      });

      const titles = {calls:"Aramalar", status:"Durum", messages:"Mesajlar", profile:"Ayarlar"};
      $("#title").textContent = titles[tab] || "Mesajlar";
      closeChat();
    }

    // ---- Auth connect
    $("#sub").textContent = "Baƒülanƒ±yor‚Ä¶";
    signInAnonymously(auth).catch(()=>{});
    onAuthStateChanged(auth, (user)=>{
      if(user){
        state.uid = user.uid;
        $("#sub").textContent = "Online ‚úÖ";
      }else{
        state.uid = null;
        $("#sub").textContent = "Offline";
      }
    });

    // ---- Chat realtime
    let currentChat = null;
    let unsubMessages = null;

    function renderChatMessages(arr){
      const box = $("#chatBody");
      box.innerHTML = arr.map(m=>{
        const me = (m.uid === state.uid);
        const meta = !me ? `<div class="bubbleMeta">${esc(m.nick || "Anon")}</div>` : "";
        return `<div class="bubble ${me ? "me":""}">${esc(m.text || "")}${meta}</div>`;
      }).join("");
      box.scrollTop = box.scrollHeight;
    }

    function openChat(chatId){
      currentChat = chats.find(c=>c.id===chatId) || null;
      if(!currentChat) return;

      $("#chatName").textContent = currentChat.name;
      $("#chatSub").textContent = state.about;

      if(unsubMessages){ try{unsubMessages();}catch{} unsubMessages=null; }

      const msgsRef = collection(db, "rooms", chatId, "messages");
      const q = query(msgsRef, orderBy("createdAt","asc"), limit(250));

      unsubMessages = onSnapshot(q, (snap)=>{
        const arr = [];
        snap.forEach(d=> arr.push(d.data()));
        currentChat.last = arr.length ? (arr[arr.length-1].text || "") : "";
        renderChats();
        renderChatMessages(arr);
      }, (err)=>{
        console.log(err);
        $("#chatSub").textContent = "Hata";
      });

      $("#overlay").classList.add("show");
      setTimeout(()=> $("#msg")?.focus?.(), 50);
    }

    function closeChat(){
      $("#overlay").classList.remove("show");
      $("#msg").value = "";
      currentChat = null;
      if(unsubMessages){ try{unsubMessages();}catch{} unsubMessages=null; }
    }

    async function sendMsg(){
      if(!currentChat) return;
      if(!state.uid) return alert("Baƒülantƒ± yok. Firebase Auth kontrol et.");
      const t = $("#msg").value.trim();
      if(!t) return;
      $("#msg").value = "";

      try{
        await addDoc(collection(db, "rooms", currentChat.id, "messages"), {
          uid: state.uid,
          nick: state.nick,
          text: t.slice(0, 1200),
          createdAt: serverTimestamp()
        });
      }catch(e){
        console.log(e);
        alert("Mesaj g√∂nderilemedi. Firestore Rules/Auth kontrol et.");
      }
    }

    // ---- Durum (global)
    let unsubStatus = null;

    function startStatusFeed(){
      if(unsubStatus){ try{unsubStatus();}catch{} unsubStatus=null; }
      const ref = collection(db, "statusPosts");
      const q = query(ref, orderBy("createdAt","desc"), limit(30));
      unsubStatus = onSnapshot(q, (snap)=>{
        const list = [];
        snap.forEach(d=> list.push(d.data()));
        const el = $("#statusList");
        el.innerHTML = list.map(s=>`
          <div class="item" style="cursor:default">
            <div class="avatar">‚ú®</div>
            <div class="meta">
              <b>${esc(s.nick || "Anon")}</b>
              <span>${esc(s.text || "")}</span>
            </div>
          </div>
        `).join("");
      });
    }

    async function sendStatus(){
      if(!state.uid) return alert("Baƒülantƒ± yok. Firebase Auth kontrol et.");
      const t = ($("#statusText").value || "").trim();
      if(!t) return;
      $("#statusText").value = "";
      $("#statusHint").textContent = "Payla≈üƒ±lƒ±yor‚Ä¶";

      try{
        await addDoc(collection(db, "statusPosts"),{
          uid: state.uid,
          nick: state.nick,
          text: t.slice(0, 500),
          createdAt: serverTimestamp()
        });
        $("#statusHint").textContent = "Payla≈üƒ±ldƒ± ‚úÖ";
        setTimeout(()=> $("#statusHint").textContent="", 1200);
      }catch(e){
        console.log(e);
        $("#statusHint").textContent = "Hata";
      }
    }

    // ---- WebView touch garanti
    function bindMulti(el, fn){
      ["click","touchend","pointerup"].forEach(ev=>{
        el.addEventListener(ev, (e)=>{
          e.preventDefault(); e.stopPropagation();
          fn();
        }, {passive:false});
      });
    }

    // ---- Klavye/textarea ta≈üma d√ºzeltme (visualViewport)
    function setupKeyboardFix(){
      const vv = window.visualViewport;
      const chatRoot = $("#chatRoot");
      if(!vv || !chatRoot) return;

      const apply = ()=>{
        // klavye a√ßƒ±lƒ±nca viewport k√º√ß√ºl√ºr, chat container height ayarla
        const h = Math.max(200, Math.floor(vv.height));
        chatRoot.style.height = h + "px";
      };
      vv.addEventListener("resize", apply)
