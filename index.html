<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>VigoChatt</title>
  <style>
    :root{
      --bg:#efe7db;
      --card:rgba(0,0,0,.06);
      --text:#1b1b1b;
      --muted:rgba(0,0,0,.55);
      --border:rgba(0,0,0,.10);
      --accent:#2b6cff;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 600px at 60% 10%, rgba(255,255,255,.75), transparent 60%),
                  radial-gradient(900px 600px at 10% 90%, rgba(255,255,255,.60), transparent 60%),
                  var(--bg);
      color:var(--text);
    }

    .app{
      max-width:520px;
      margin:0 auto;
      height:100dvh;
      display:flex;
      flex-direction:column;
      padding-top: var(--safe-top);
      padding-bottom: calc(84px + var(--safe-bottom));
    }

    /* Header */
    .header{
      padding:16px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .header h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .header small{color:var(--muted)}
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .pill:active{transform:scale(.98)}

    /* Views */
    .view{
      display:none;
      padding: 6px 16px 16px;
      overflow:auto;
      flex:1;
    }
    .view.active{display:block}

    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 12px;
    }
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      display:flex; align-items:center; gap:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      border-radius: 16px;
      padding: 12px;
      cursor:pointer;
      user-select:none;
    }
    .item:active{transform:scale(.99)}
    .avatar{
      width:44px;height:44px;border-radius:16px;
      background: rgba(43,108,255,.12);
      border:1px solid rgba(43,108,255,.18);
      display:grid; place-items:center;
      font-weight:900;
      color:var(--accent);
      flex:0 0 auto;
      overflow:hidden;
    }
    .meta{min-width:0; flex:1}
    .meta b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta span{display:block; font-size:13px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:3px}

    /* Chat overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.15);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display:none;
      z-index: 50;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }
    .overlay.show{display:block}

    .chat{
      max-width:520px;
      margin:0 auto;
      height:100%;
      display:flex;
      flex-direction:column;
      background: rgba(255,255,255,.50);
    }
    .chatTop{
      padding: 12px 14px;
      display:flex; align-items:center; gap:10px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.55);
    }
    .btn{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .chatTitle{min-width:0; flex:1}
    .chatTitle b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .chatTitle span{display:block; font-size:12px; color:var(--muted)}

    .chatBody{
      flex:1;
      overflow:auto;
      padding: 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubble{
      max-width:78%;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      font-size:14px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bubble.me{
      margin-left:auto;
      background: rgba(43,108,255,.12);
      border-color: rgba(43,108,255,.20);
    }
    .bubble .t{
      display:block;
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
    .composer{
      padding: 10px 14px calc(10px + var(--safe-bottom));
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.55);
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .composer textarea{
      flex:1;
      min-height:44px;
      max-height:140px;
      resize:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      border-radius: 16px;
      padding: 12px;
      outline:none;
      font-size:14px;
    }
    .send{
      width:52px;height:52px;
      border-radius:16px;
      border:1px solid rgba(43,108,255,.25);
      background: rgba(43,108,255,.12);
      color: var(--accent);
      font-weight:900;
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
    }

    /* Bottom bar (AYNI) */
    .bottom{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:9999;
      padding: 10px 12px calc(10px + var(--safe-bottom));
      display:flex;
      justify-content:center;
    }
    .nav{
      width:min(520px, calc(100% - 24px));
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      border-radius: 22px;
      padding: 10px;
      display:flex;
      gap:8px;
    }
    .tab{
      flex:1;
      border-radius: 16px;
      padding: 10px 6px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
      color:var(--muted);
      border:1px solid transparent;
    }
    .tab.active{
      color: var(--text);
      background: rgba(43,108,255,.10);
      border-color: rgba(43,108,255,.18);
    }
    .tab .ico{font-size:20px; line-height:1}
    .tab .lbl{font-size:12px; font-weight:800}

    /* --- Modallar (tema bozmadan) --- */
    .modal{
      position:fixed; inset:0;
      z-index: 80;
      display:none;
      background: rgba(0,0,0,.15);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }
    .modal.show{display:block}
    .sheet{
      max-width:520px;
      margin: 10px auto 0;
      border:1px solid var(--border);
      background: rgba(255,255,255,.70);
      border-radius: 18px;
      overflow:hidden;
    }
    .sheetHd{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.55);
    }
    .sheetBd{padding:14px}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
    .field label{font-size:12px; color:var(--muted)}
    .inp{
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      border-radius: 16px;
      padding: 12px;
      outline:none;
      font-size:14px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn2{
      border:1px solid var(--border);
      background: rgba(255,255,255,.65);
      border-radius: 16px;
      padding: 12px 14px;
      cursor:pointer;
      font-weight:900;
      user-select:none;
    }
    .btn2.primary{
      border-color: rgba(43,108,255,.25);
      background: rgba(43,108,255,.12);
      color: var(--accent);
    }
    .err{color:#ef4444; font-size:13px; margin-top:6px}
    .muted{color:var(--muted); font-size:13px; line-height:1.35}
    .hr{height:1px; background:var(--border); margin:12px 0}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(92px + var(--safe-bottom));
      z-index:99999;
      background: rgba(0,0,0,.78);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      display:none;
      max-width: calc(100% - 24px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="toast" id="toast">...</div>

  <div class="app">
    <div class="header">
      <div>
        <h1 id="title">Mesajlar</h1>
        <small id="sub">VigoChatt</small>
      </div>
      <div class="pill" id="addBtn">Ôºã</div>
    </div>

    <!-- Aramalar -->
    <section class="view" id="view-calls">
      <div class="card">
        <b>Aramalar</b>
        <div class="muted" style="margin-top:6px">
          Bu ekranda sohbet listenden ki≈üiler g√∂r√ºn√ºr.
          Sesli arama (WhatsApp gibi) i√ßin native/Capacitor gerekir.
        </div>
      </div>
      <div class="list" id="callsList"></div>
    </section>

    <!-- Durum -->
    <section class="view" id="view-status">
      <div class="card">
        <b>Durum</b>
        <div class="muted" style="margin-top:6px">
          Durum yazƒ±p payla≈üabilirsin.
        </div>
        <div class="hr"></div>
        <div class="row">
          <input class="inp" id="statusText" placeholder="Durum yaz...">
          <div class="btn2 primary" id="statusSend">Payla≈ü</div>
        </div>
      </div>
      <div class="list" id="statusList"></div>
    </section>

    <!-- Mesajlar -->
    <section class="view active" id="view-messages">
      <div class="card">
        <b>Mesajlar</b>
        <div class="muted" style="margin-top:6px">
          ‚ÄúÔºã‚Äù ile yeni sohbet ba≈ülat ‚Üí mesaj g√∂nder.
        </div>
      </div>
      <div class="list" id="chatList"></div>
      <div class="card" id="emptyChats" style="display:none">
        <b>Hen√ºz sohbet yok</b>
        <div class="muted" style="margin-top:6px">√ústteki ‚ÄúÔºã‚Äù ile sohbet a√ß.</div>
      </div>
    </section>

    <!-- Profil -->
    <section class="view" id="view-profile">
      <div class="card">
        <b>Profil</b>
        <div class="muted" style="margin-top:6px">
          Bilgilerini d√ºzenle.
        </div>
      </div>

      <div class="card">
        <div class="field">
          <label>Ad</label>
          <input class="inp" id="pName" placeholder="Adƒ±n">
        </div>
        <div class="field">
          <label>Doƒüum g√ºn√º</label>
          <input class="inp" id="pBday" type="date">
        </div>
        <div class="field">
          <label>Hakkƒ±nda</label>
          <textarea class="inp" id="pAbout" placeholder="Kƒ±sa a√ßƒ±klama..." style="min-height:90px"></textarea>
        </div>

        <div class="row">
          <div class="btn2 primary" id="saveProfile">Kaydet</div>
          <div class="btn2" id="openSettings">Ayarlar</div>
          <div class="btn2" id="logout">√áƒ±kƒ±≈ü</div>
        </div>

        <div class="hr"></div>
        <div class="muted" id="meInfo">‚Äî</div>
      </div>
    </section>
  </div>

  <!-- Chat overlay -->
  <div class="overlay" id="overlay">
    <div class="chat">
      <div class="chatTop">
        <div class="btn" id="back">‚Üê</div>
        <div class="chatTitle">
          <b id="chatName">Sohbet</b>
          <span id="chatSub">‚Äî</span>
        </div>
        <div class="btn" id="more">‚ãØ</div>
      </div>
      <div class="chatBody" id="chatBody"></div>
      <div class="composer">
        <textarea id="msg" rows="1" placeholder="Mesaj yaz..."></textarea>
        <div class="send" id="send">‚û§</div>
      </div>
    </div>
  </div>

  <!-- Bottom nav (AYNI) -->
  <div class="bottom">
    <nav class="nav">
      <div class="tab" data-tab="calls"><div class="ico">üë•</div><div class="lbl">Aramalar</div></div>
      <div class="tab" data-tab="status"><div class="ico">‚ùó</div><div class="lbl">Durum</div></div>
      <div class="tab active" data-tab="messages"><div class="ico">üì∂</div><div class="lbl">Mesajlar</div></div>
      <div class="tab" data-tab="profile"><div class="ico">ü§î</div><div class="lbl">Profil</div></div>
    </nav>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="authModal">
    <div class="sheet">
      <div class="sheetHd">
        <b>VigoChatt ‚Ä¢ Giri≈ü</b>
        <div class="btn" id="closeAuth" style="width:44px;height:44px">‚úï</div>
      </div>
      <div class="sheetBd">
        <div class="muted">Firebase‚Äôe giri≈ü yapƒ±nca ger√ßek kullanƒ±cƒ±larla mesajla≈üacaksƒ±n.</div>
        <div class="hr"></div>

        <div class="field">
          <label>E-posta</label>
          <input class="inp" id="email" type="email" placeholder="ornek@mail.com">
        </div>
        <div class="field">
          <label>≈ûifre (min 6)</label>
          <input class="inp" id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>

        <div class="row">
          <div class="btn2 primary" id="loginBtn">Giri≈ü</div>
          <div class="btn2" id="signupBtn">Kayƒ±t</div>
        </div>

        <div class="err" id="authErr"></div>

        <div class="hr"></div>
        <div class="muted">
          Not: ‚ÄúNumara ile giri≈ü / rehber / sesli arama‚Äù WebView-APK‚Äôde native gerekir.
          Bu s√ºr√ºmde en sorunsuz √ßalƒ±≈üan: Firebase e-posta ile ger√ßek chat.
        </div>
      </div>
    </div>
  </div>

  <!-- New Chat Modal -->
  <div class="modal" id="newChatModal">
    <div class="sheet">
      <div class="sheetHd">
        <b>Yeni Sohbet</b>
        <div class="btn" id="closeNewChat" style="width:44px;height:44px">‚úï</div>
      </div>
      <div class="sheetBd">
        <div class="muted">Arkada≈üƒ±nƒ±n kayƒ±tlƒ± e-postasƒ±nƒ± yaz (o da VigoChatt‚Äôte kayƒ±t olmalƒ±).</div>
        <div class="hr"></div>

        <div class="field">
          <label>E-posta</label>
          <input class="inp" id="newChatEmail" placeholder="arkadas@mail.com">
        </div>

        <div class="row">
          <div class="btn2 primary" id="startChat">Sohbet Ba≈ülat</div>
          <div class="btn2" id="copyMyEmail">Benim e-postam</div>
        </div>

        <div class="err" id="newChatErr"></div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="sheet">
      <div class="sheetHd">
        <b>Ayarlar</b>
        <div class="btn" id="closeSettings" style="width:44px;height:44px">‚úï</div>
      </div>
      <div class="sheetBd">
        <div class="card" style="margin:0">
          <b>Uygulama</b>
          <div class="muted" style="margin-top:6px">
            VigoChatt ‚Ä¢ Firebase ger√ßek mesajla≈üma
          </div>
        </div>
        <div class="hr"></div>
        <div class="btn2" id="howVoice">Sesli arama neden yok?</div>
      </div>
    </div>
  </div>

  <!-- Firebase (ES module yok: APK'de bo≈ü ekran yapmasƒ±n diye) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    const $ = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function toast(msg){
      const t=$("#toast");
      t.textContent=msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm=setTimeout(()=>t.classList.remove("show"),2200);
    }
    function fmtTime(ts){
      try{
        const d=new Date(ts);
        return d.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
      }catch(e){return "";}
    }
    function modal(id, on){
      $(id).classList.toggle("show", !!on);
    }

    // === Firebase config (SENƒ∞N) ===
    const firebaseConfig = {
      apiKey: "AIzaSyA3--Xy1WrM6WlxurXXr4i5qwMZiafXN4k",
      authDomain: "vigochat-58144.firebaseapp.com",
      databaseURL: "https://vigochat-58144-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "vigochat-58144",
      storageBucket: "vigochat-58144.firebasestorage.app",
      messagingSenderId: "384136632816",
      appId: "1:384136632816:web:2bb6d6942680a2e2e6e535",
      measurementId: "G-62VZ3906GS"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- Data model ---
    // profiles/{uid}: {emailLower, name, about, bday, createdAt, lastSeen}
    // inbox/{uid}/{threadId}: {otherUid, otherName, lastText, lastAt}
    // messages/{threadId}/{msgId}: {uid, text, at}
    // statuses/{uid}/{statusId}: {text, at}

    let me = null;
    let myProfile = null;

    let currentThreadId = null;
    let currentOther = null;
    let messagesOff = null;

    function threadIdFor(a,b){
      return [a,b].sort().join("_");
    }

    async function ensureProfile(user){
      const pRef = db.ref("profiles/"+user.uid);
      const snap = await pRef.get();
      const emailLower = (user.email || "").toLowerCase();

      if(!snap.exists()){
        const base = {
          email: user.email || "",
          emailLower,
          name:"",
          about:"",
          bday:"",
          createdAt: Date.now(),
          lastSeen: Date.now()
        };
        await pRef.set(base);
        return base;
      }else{
        const v = snap.val() || {};
        if(v.emailLower !== emailLower){
          await pRef.update({email: user.email || "", emailLower});
        }
        return Object.assign({}, v, {email: user.email || v.email || ""});
      }
    }

    function setTab(tab){
      $$(".tab").forEach(t=> t.classList.toggle("active", t.dataset.tab === tab));
      ["calls","status","messages","profile"].forEach(v=>{
        const view = $("#view-" + v);
        if(view) view.classList.toggle("active", v === tab);
      });

      const titles = {calls:"Aramalar", status:"Durum", messages:"Mesajlar", profile:"Profil"};
      $("#title").textContent = titles[tab] || "Mesajlar";

      // sub
      if(me){
        $("#sub").textContent = myProfile?.name ? ("VigoChatt ‚Ä¢ " + myProfile.name) : "VigoChatt ‚Ä¢ √ßevrimi√ßi";
      }else{
        $("#sub").textContent = "VigoChatt ‚Ä¢ giri≈ü gerekli";
      }

      closeChat();
    }

    // --- AUTH ---
    async function loginEmail(){
      $("#authErr").textContent="";
      const email = $("#email").value.trim();
      const pass = $("#pass").value;
      if(!email || !pass) return $("#authErr").textContent="E-posta ve ≈üifre gir.";
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        $("#authErr").textContent = (e && e.message) ? e.message : "Giri≈ü hatasƒ±";
      }
    }
    async function signupEmail(){
      $("#authErr").textContent="";
      const email = $("#email").value.trim();
      const pass = $("#pass").value;
      if(!email || !pass || pass.length<6) return $("#authErr").textContent="E-posta ve min 6 ≈üifre gir.";
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
      }catch(e){
        $("#authErr").textContent = (e && e.message) ? e.message : "Kayƒ±t hatasƒ±";
      }
    }
    async function logout(){
      try{ await auth.signOut(); }catch(e){}
    }

    // --- Profile UI ---
    async function saveProfile(){
      if(!me) return;
      const name = $("#pName").value.trim();
      const about = $("#pAbout").value.trim();
      const bday = $("#pBday").value;

      await db.ref("profiles/"+me.uid).update({
        name, about, bday, lastSeen: Date.now()
      });

      toast("Kaydedildi");
    }

    function paintProfile(){
      $("#pName").value = myProfile?.name || "";
      $("#pAbout").value = myProfile?.about || "";
      $("#pBday").value = myProfile?.bday || "";
      $("#meInfo").innerHTML = "<b>E-posta:</b> "+escapeHtml(me?.email || "-");
    }

    // --- New Chat: find user by emailLower ---
    async function findUserByEmail(email){
      const e = (email || "").trim().toLowerCase();
      if(!e) return null;

      const q = db.ref("profiles").orderByChild("emailLower").equalTo(e);
      const snap = await q.get();
      if(!snap.exists()) return null;

      const obj = snap.val();
      const uid = Object.keys(obj)[0];
      return { uid, ...obj[uid] };
    }

    async function startChat(){
      $("#newChatErr").textContent="";
      if(!me) return;

      const email = $("#newChatEmail").value.trim();
      const other = await findUserByEmail(email);

      if(!other){
        $("#newChatErr").textContent="Bu e-posta ile kayƒ±tlƒ± kullanƒ±cƒ± yok. Arkada≈üƒ±n √∂nce kayƒ±t olsun.";
        return;
      }
      if(other.uid === me.uid){
        $("#newChatErr").textContent="Kendi e-postanla sohbet a√ßamazsƒ±n.";
        return;
      }

      const tid = threadIdFor(me.uid, other.uid);

      // inbox for me
      await db.ref("inbox/"+me.uid+"/"+tid).update({
        otherUid: other.uid,
        otherName: other.name || other.email || "Kullanƒ±cƒ±",
        lastText: "",
        lastAt: Date.now()
      });

      // inbox for other
      const myName = myProfile?.name || me.email || "Kullanƒ±cƒ±";
      await db.ref("inbox/"+other.uid+"/"+tid).update({
        otherUid: me.uid,
        otherName: myName,
        lastText: "",
        lastAt: Date.now()
      });

      modal("#newChatModal", false);
      toast("Sohbet a√ßƒ±ldƒ±");
      openChat(tid, {uid: other.uid, name: other.name || other.email || "Kullanƒ±cƒ±"});
      setTab("messages");
    }

    async function copyMyEmail(){
      try{
        await navigator.clipboard.writeText(me?.email || "");
        toast("Kopyalandƒ±");
      }catch(e){
        toast(me?.email || "‚Äî");
      }
    }

    // --- Inbox render ---
    function renderInbox(list){
      const el = $("#chatList");
      const empty = $("#emptyChats");

      if(!list.length){
        el.innerHTML = "";
        empty.style.display = "block";
        $("#callsList").innerHTML = "";
        return;
      }

      empty.style.display = "none";
      el.innerHTML = list.map(x=>{
        const initial = (x.otherName || "V")[0].toUpperCase();
        return `
          <div class="item" data-thread="${escapeHtml(x.tid)}" data-ouid="${escapeHtml(x.otherUid)}" data-oname="${escapeHtml(x.otherName||"Kullanƒ±cƒ±")}">
            <div class="avatar">${escapeHtml(initial)}</div>
            <div class="meta">
              <b>${escapeHtml(x.otherName||"Kullanƒ±cƒ±")}</b>
              <span>${escapeHtml(x.lastText || "Hen√ºz mesaj yok")}</span>
            </div>
          </div>
        `;
      }).join("");

      // Calls list uses same people (demo call)
      $("#callsList").innerHTML = list.map(x=>{
        const initial = "üìû";
        return `
          <div class="item" data-call="1">
            <div class="avatar">${initial}</div>
            <div class="meta">
              <b>${escapeHtml(x.otherName||"Kullanƒ±cƒ±")}</b>
              <span>Sesli arama: native gerekir</span>
            </div>
          </div>
        `;
      }).join("");
    }

    function listenInbox(){
      if(!me) return;
      db.ref("inbox/"+me.uid).on("value", (snap)=>{
        const data = snap.val() || {};
        const arr = Object.entries(data).map(([tid,v])=>({
          tid,
          otherUid: v.otherUid || "",
          otherName: v.otherName || "Kullanƒ±cƒ±",
          lastText: v.lastText || "",
          lastAt: v.lastAt || 0
        })).sort((a,b)=> (b.lastAt||0) - (a.lastAt||0));

        renderInbox(arr);
      });
    }

    // --- Messages ---
    function openChat(tid, other){
      currentThreadId = tid;
      currentOther = other;

      $("#chatName").textContent = other?.name || "Sohbet";
      $("#chatSub").textContent = "√ßevrimi√ßi";
      $("#overlay").classList.add("show");

      const ref = db.ref("messages/"+tid);

      if(messagesOff){ messagesOff(); messagesOff=null; }
      const handler = (snap)=>{
        const data = snap.val() || {};
        const arr = Object.entries(data).map(([k,v])=>({k,...v}))
          .sort((a,b)=> (a.at||0)-(b.at||0))
          .slice(-250);

        $("#chatBody").innerHTML = arr.map(m=>{
          const meMsg = (m.uid === me.uid);
          return `<div class="bubble ${meMsg?"me":""}">
            ${escapeHtml(m.text||"")}
            <span class="t">${escapeHtml(fmtTime(m.at||Date.now()))}</span>
          </div>`;
        }).join("");
        $("#chatBody").scrollTop = $("#chatBody").scrollHeight;
      };

      ref.on("value", handler);
      messagesOff = ()=> ref.off("value", handler);
    }

    function closeChat(){
      $("#overlay").classList.remove("show");
      $("#msg").value = "";
      currentThreadId = null;
      currentOther = null;
      if(messagesOff){ messagesOff(); messagesOff=null; }
    }

    async function sendMsg(){
      if(!me || !currentThreadId || !currentOther) return;
      const t = $("#msg").value.trim();
      if(!t) return;

      $("#msg").value = "";
      const now = Date.now();

      // push message
      await db.ref("messages/"+currentThreadId).push({
        uid: me.uid,
        text: t,
        at: now
      });

      // update inbox for both
      await db.ref("inbox/"+me.uid+"/"+currentThreadId).update({
        otherUid: currentOther.uid,
        otherName: currentOther.name || "Kullanƒ±cƒ±",
        lastText: t,
        lastAt: now
      });

      const myName = myProfile?.name || me.email || "Kullanƒ±cƒ±";
      await db.ref("inbox/"+currentOther.uid+"/"+currentThreadId).update({
        otherUid: me.uid,
        otherName: myName,
        lastText: t,
        lastAt: now
      });
    }

    // --- Status ---
    async function addStatus(){
      if(!me) return toast("Giri≈ü yap");
      const text = $("#statusText").value.trim();
      if(!text) return;
      $("#statusText").value = "";
      await db.ref("statuses/"+me.uid).push({text, at: Date.now()});
      toast("Durum payla≈üƒ±ldƒ±");
    }

    function listenStatus(){
      if(!me) return;
      db.ref("statuses/"+me.uid).on("value", (snap)=>{
        const data = snap.val() || {};
        const arr = Object.entries(data).map(([k,v])=>({k,...v}))
          .sort((a,b)=> (b.at||0)-(a.at||0))
          .slice(0,30);

        const el = $("#statusList");
        if(!arr.length){
          el.innerHTML = `<div class="card"><b>Durum yok</b><div class="muted" style="margin-top:6px">Yukarƒ±dan durum payla≈ü.</div></div>`;
          return;
        }
        el.innerHTML = arr.map(s=>`
          <div class="item" style="cursor:default">
            <div class="avatar">‚ùó</div>
            <div class="meta">
              <b>${escapeHtml(myProfile?.name || "Sen")}</b>
              <span>${escapeHtml(s.text || "")}</span>
            </div>
          </div>
        `).join("");
      });
    }

    // --- Click + Events ---
    document.addEventListener("click", (e)=>{
      const tab = e.target.closest(".tab");
      if(tab){
        setTab(tab.dataset.tab);
        if(!me) modal("#authModal", true);
        return;
      }

      const chatItem = e.target.closest("#chatList .item");
      if(chatItem){
        if(!me){ modal("#authModal", true); return; }
        openChat(chatItem.dataset.thread, {
          uid: chatItem.dataset.ouid,
          name: chatItem.dataset.oname
        });
        return;
      }

      const callItem = e.target.closest("#callsList .item");
      if(callItem){
        alert("Sesli arama i√ßin Android native/Capacitor gerekir (WebView tek HTML ile WhatsApp gibi olmaz).");
        return;
      }
    });

    $("#back").addEventListener("click", closeChat);
    $("#send").addEventListener("click", sendMsg);
    $("#msg").addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMsg();
      }
    });

    $("#addBtn").addEventListener("click", ()=>{
      if(!me){ modal("#authModal", true); return; }
      $("#newChatErr").textContent="";
      $("#newChatEmail").value="";
      modal("#newChatModal", true);
      setTimeout(()=>$("#newChatEmail").focus(), 50);
    });

    $("#closeAuth").addEventListener("click", ()=> modal("#authModal", false));
    $("#closeNewChat").addEventListener("click", ()=> modal("#newChatModal", false));
    $("#closeSettings").addEventListener("click", ()=> modal("#settingsModal", false));

    $("#loginBtn").addEventListener("click", loginEmail);
    $("#signupBtn").addEventListener("click", signupEmail);

    $("#startChat").addEventListener("click", startChat);
    $("#newChatEmail").addEventListener("keydown", (e)=>{ if(e.key==="Enter") startChat(); });

    $("#copyMyEmail").addEventListener("click", copyMyEmail);

    $("#saveProfile").addEventListener("click", saveProfile);
    $("#logout").addEventListener("click", logout);
    $("#openSettings").addEventListener("click", ()=> modal("#settingsModal", true));
    $("#howVoice").addEventListener("click", ()=>{
      alert("Sesli arama (WhatsApp gibi) i√ßin native uygulama gerekir.\nƒ∞stersen sonraki adƒ±mda Capacitor/Android projesi kurup ekleriz.");
    });

    $("#statusSend").addEventListener("click", addStatus);
    $("#statusText").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); addStatus(); } });

    // Close modals by tapping background
    ["#authModal","#newChatModal","#settingsModal"].forEach(id=>{
      $(id).addEventListener("click",(e)=>{ if(e.target.id === id.slice(1)) modal(id,false); });
    });

    // --- Auth state ---
    auth.onAuthStateChanged(async (user)=>{
      me = user || null;

      if(!me){
        myProfile = null;
        $("#chatList").innerHTML = "";
        $("#callsList").innerHTML = "";
        $("#statusList").innerHTML = "";
        $("#emptyChats").style.display = "block";
        $("#sub").textContent = "VigoChatt ‚Ä¢ giri≈ü gerekli";
        modal("#authModal", true);
        return;
      }

      myProfile = await ensureProfile(me);
      paintProfile();
      $("#sub").textContent = myProfile?.name ? ("VigoChatt ‚Ä¢ " + myProfile.name) : "VigoChatt ‚Ä¢ √ßevrimi√ßi";

      // Listen data
      listenInbox();
      listenStatus();

      modal("#authModal", false);
      toast("Giri≈ü ba≈üarƒ±lƒ±");
      setTab("messages");
    });

    // Init
    setTab("messages");
    $("#emptyChats").style.display = "block";
  </script>
</body>
</html>
