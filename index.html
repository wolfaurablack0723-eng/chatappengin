<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>VigoChatt</title>
  <style>
    :root{
      --bg:#efe7db;
      --card:rgba(0,0,0,.06);
      --text:#1b1b1b;
      --muted:rgba(0,0,0,.55);
      --border:rgba(0,0,0,.10);
      --accent:#2b6cff;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 600px at 60% 10%, rgba(255,255,255,.75), transparent 60%),
                  radial-gradient(900px 600px at 10% 90%, rgba(255,255,255,.60), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:520px;
      margin:0 auto;
      height:100dvh;
      display:flex;
      flex-direction:column;
      padding-top: var(--safe-top);
      padding-bottom: calc(84px + var(--safe-bottom));
    }
    .top{
      padding:16px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .top h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .top small{display:block; color:var(--muted); font-size:12px;}
    #fbState{font-size:11px; margin-left:4px;}
    #fbState.ok{color:#15803d;}
    #fbState.danger{color:#b91c1c;}
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .pill:active{transform:scale(.97)}

    .view{
      display:none;
      padding: 6px 16px 16px;
      overflow:auto;
      flex:1;
    }
    .view.active{display:block;}
    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.55);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 12px;
      font-size:14px;
    }
    .card h2{
      margin:0 0 6px;
      font-size:15px;
    }
    .card small.hint{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:8px;
      font-size:13px;
    }
    .field label{font-size:12px; color:var(--muted);}
    .field input,
    .field textarea{
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.8);
      padding:9px 11px;
      font-size:14px;
      outline:none;
    }
    .field textarea{
      min-height:60px;
      resize:vertical;
    }
    .row{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.9);
      padding:8px 14px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{
      border-color: rgba(43,108,255,.25);
      background: rgba(43,108,255,.12);
      color:var(--accent);
      font-weight:600;
    }
    .btn:active{transform:scale(.97)}
    .text-danger{color:#b91c1c; font-size:12px; margin-top:4px;}
    .muted{color:var(--muted); font-size:12px;}

    .list{display:flex; flex-direction:column; gap:8px; margin-top:6px;}
    .item{
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.7);
      border-radius:16px;
      padding:9px 11px;
      cursor:pointer;
    }
    .item:active{transform:scale(.99)}
    .avatar{
      width:40px;height:40px;border-radius:16px;
      background: rgba(43,108,255,.10);
      border:1px solid rgba(43,108,255,.18);
      display:grid; place-items:center;
      font-weight:800;
      color:var(--accent);
      flex:0 0 auto;
    }
    .meta{min-width:0;flex:1;}
    .meta b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .meta span{display:block; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px;}

    .bottom{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + var(--safe-bottom));
      display:flex;
      justify-content:center;
    }
    .nav{
      width:min(520px, calc(100% - 24px));
      border-radius:22px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.7);
      padding:8px;
      display:flex;
      gap:6px;
    }
    .tabBtn{
      flex:1;
      border-radius:16px;
      border:1px solid transparent;
      padding:8px 4px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size:11px;
      color:var(--muted);
      background:transparent;
      cursor:pointer;
    }
    .tabBtn .ico{font-size:18px;}
    .tabBtn .lbl{font-weight:800;}
    .tabBtn.active{
      color:var(--text);
      background: rgba(43,108,255,.10);
      border-color: rgba(43,108,255,.22);
    }

    /* Chat overlay */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display:none;
      padding-top:var(--safe-top);
      padding-bottom:var(--safe-bottom);
      z-index:40;
    }
    .overlay.show{display:block;}
    .chatPanel{
      max-width:520px;
      margin:0 auto;
      height:100%;
      background:rgba(255,255,255,.92);
      display:flex;
      flex-direction:column;
    }
    .chatTop{
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:8px;
      border-bottom:1px solid var(--border);
    }
    .chatBody{
      flex:1;
      padding:10px 12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .bubble{
      max-width:78%;
      font-size:14px;
      border-radius:14px;
      padding:8px 10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.9);
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bubble.me{
      margin-left:auto;
      background:rgba(43,108,255,.10);
      border-color:rgba(43,108,255,.25);
    }
    .composer{
      padding:8px 10px calc(8px + var(--safe-bottom));
      display:flex;
      gap:8px;
      border-top:1px solid var(--border);
      background:rgba(255,255,255,.95);
    }
    .composer textarea{
      flex:1;
      min-height:40px;
      max-height:120px;
      resize:none;
      border-radius:14px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:14px;
      background:rgba(255,255,255,.95);
      outline:none;
    }
    .sendBtn{
      width:44px;height:44px;
      border-radius:999px;
      border:1px solid rgba(43,108,255,.25);
      background:rgba(43,108,255,.12);
      color:var(--accent);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      font-weight:800;
    }
    .sendBtn:active{transform:scale(.95);}
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 id="title">VigoChatt</h1>
        <small id="sub">A√ßƒ±lƒ±yor‚Ä¶ <span id="fbState"></span></small>
      </div>
      <button class="pill" id="logoutBtn" type="button" style="display:none">√áƒ±kƒ±≈ü</button>
    </div>

    <!-- AUTH -->
    <section class="view active" id="view-auth">
      <div class="card">
        <h2>Giri≈ü / Kayƒ±t</h2>
        <div class="field">
          <label for="email">E-posta</label>
          <input id="email" type="email" placeholder="ornek@mail.com"/>
        </div>
        <div class="field">
          <label for="pass">≈ûifre (min 6 karakter)</label>
          <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>
        <div class="row">
          <button class="btn primary" id="loginBtn" type="button">Giri≈ü yap</button>
          <button class="btn" id="signupBtn" type="button">Kayƒ±t ol</button>
        </div>
        <div id="authErr" class="text-danger"></div>
        <small class="hint">Kayƒ±t olduktan sonra arkada≈ülarƒ±nƒ±n mail adresi ile sohbet a√ßabilirsin.</small>
      </div>
    </section>

    <!-- CHATS -->
    <section class="view" id="view-chats">
      <div class="card">
        <h2>Sohbetler</h2>
        <div class="muted" id="mustLoginChats"></div>
        <div class="field" style="margin-top:10px;">
          <label for="startEmail">Yeni sohbet i√ßin arkada≈ü e-postasƒ±</label>
          <input id="startEmail" type="email" placeholder="arkadas@mail.com"/>
        </div>
        <div class="row">
          <button class="btn primary" id="startBtn" type="button">Sohbet ba≈ülat</button>
        </div>
        <div id="startErr" class="text-danger"></div>
      </div>
      <div class="card">
        <h2>Sohbet listesi</h2>
        <div class="list" id="threadList"></div>
      </div>
    </section>

    <!-- STATUS -->
    <section class="view" id="view-status">
      <div class="card">
        <h2>Durum</h2>
        <div class="muted" id="mustLoginStatus"></div>
        <p style="margin-top:6px; font-size:13px;">
          ≈ûimdilik durum ekranƒ± demo. ƒ∞stersen profil kƒ±smƒ±na yazdƒ±ƒüƒ±n "Hakkƒ±mda" bilgisi durum gibi kullanƒ±labilir.
        </p>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="view" id="view-settings">
      <div class="card">
        <h2>Profil / Ayarlar</h2>
        <div class="muted" id="mustLoginSettings"></div>
        <div class="field">
          <label for="name">G√∂r√ºnen ad</label>
          <input id="name" type="text" placeholder="Adƒ±n"/>
        </div>
        <div class="field">
          <label for="about">Hakkƒ±mda / Durum</label>
          <textarea id="about" placeholder="√∂rn. √ßevrimi√ßi"></textarea>
        </div>
        <div class="row">
          <button class="btn primary" id="saveProfile" type="button">Kaydet</button>
        </div>
        <div id="saveHint" class="muted"></div>
      </div>
    </section>
  </div>

  <!-- Bottom nav -->
  <div class="bottom">
    <nav class="nav">
      <button class="tabBtn active" type="button" data-tab="chats">
        <div class="ico">üí¨</div><div class="lbl">Sohbetler</div>
      </button>
      <button class="tabBtn" type="button" data-tab="status">
        <div class="ico">üì¢</div><div class="lbl">Durum</div>
      </button>
      <button class="tabBtn" type="button" data-tab="settings">
        <div class="ico">‚öôÔ∏è</div><div class="lbl">Ayarlar</div>
      </button>
    </nav>
  </div>

  <!-- Chat overlay -->
  <div class="overlay" id="overlay">
    <div class="chatPanel">
      <div class="chatTop">
        <button class="btn" id="back" type="button">‚Üê</button>
        <div style="min-width:0;flex:1;">
          <div id="chatTitle" style="font-size:14px;font-weight:600; white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Sohbet</div>
          <div id="chatSubtitle" class="muted" style="font-size:11px;">√ßevrimi√ßi</div>
        </div>
      </div>
      <div class="chatBody" id="chatBody"></div>
      <div class="composer">
        <textarea id="msg" placeholder="Mesaj yaz..."></textarea>
        <button class="sendBtn" id="send" type="button">‚û§</button>
      </div>
    </div>
  </div>

  <script>
    // ---- helpers
    const $ = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
    const esc = (s)=> String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));

    let auth = null;
    const state = {
      uid: null,
      email: "",
      name: "",
      db: null,
      currentThreadId: null,
      currentOther: null
    };
    let unsubThreads = null;
    let unsubMsgs = null;

    function setView(id){
      ["auth","chats","status","settings"].forEach(v=>{
        const view = $("#view-"+v);
        if(view) view.classList.toggle("active", v===id);
      });
      $$(".tabBtn").forEach(t=> t.classList.toggle("active", t.dataset.tab===id));
      const titles = {
        auth:"VigoChatt",
        chats:"Sohbetler",
        status:"Durum",
        settings:"Ayarlar"
      };
      $("#title").textContent = titles[id] || "VigoChatt";
    }

    function renderMustLoginHints(){
      const msg = state.uid ? "" : "Giri≈ü yapmadan bu sayfa sadece g√∂r√ºnt√ºlenir. ƒ∞≈ülem i√ßin giri≈ü yap.";
      $("#mustLoginChats").textContent = msg;
      $("#mustLoginStatus").textContent = msg;
      $("#mustLoginSettings").textContent = msg;
      $("#logoutBtn").style.display = state.uid ? "inline-block" : "none";
    }

    function threadIdFor(a,b){ return (a<b) ? (a+"_"+b) : (b+"_"+a); }

    function renderThreads(list){
      const el = $("#threadList");
      if(!el) return;
      if(!state.uid){
        el.innerHTML = "<div class='muted'>√ñnce giri≈ü yap.</div>";
        return;
      }
      if(!list.length){
        el.innerHTML = "<div class='muted'>Hen√ºz sohbet yok. √ústten bir e-posta ile sohbet ba≈ülat.</div>";
        return;
      }
      el.innerHTML = list.map(t=>{
        const meFirst = (t.a && t.a.uid === state.uid) ? t.a : t.b;
        const other = (t.a && t.a.uid === state.uid) ? t.b : t.a;
        const name = (other && other.name) || "Kullanƒ±cƒ±";
        const last = t.lastText || "";
        const initial = (name[0] || "?").toUpperCase();
        return `
          <div class="item" data-tid="${esc(t.id)}" data-name="${esc(name)}">
            <div class="avatar">${esc(initial)}</div>
            <div class="meta">
              <b>${esc(name)}</b>
              <span>${esc(last)}</span>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderMessages(list){
      const box = $("#chatBody");
      if(!box) return;
      box.innerHTML = list.map(m=>{
        const mine = m.from === state.uid;
        return `<div class="bubble ${mine ? "me":""}">${esc(m.text||"")}</div>`;
      }).join("");
      box.scrollTop = box.scrollHeight;
    }

    function subscribeThreadList(){
      if(!state.uid || !state.db) return;
      if(unsubThreads) unsubThreads();

      unsubThreads = state.db.collection("threads")
        .orderBy("updatedAt","desc")
        .limit(50)
        .onSnapshot((snap)=>{
          const list = [];
          snap.forEach(d=>{
            const t = d.data();
            if(Array.isArray(t.participants) && t.participants.includes(state.uid)){
              list.push({id:d.id, ...t});
            }
          });
          renderThreads(list);
        });
    }
async function sendMsg(){
      const text = ($("#msg").value||"").trim();
      if(!text || !state.uid || !state.db || !state.currentThreadId) return;

      const tRef = state.db.collection("threads").doc(state.currentThreadId);
      const mRef = tRef.collection("msgs").doc();

      const payload = {
        from: state.uid,
        text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      $("#msg").value = "";
      autoGrow($("#msg"));

      await Promise.all([
        mRef.set(payload),
        tRef.update({
          lastText: text,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        })
      ]);
    }

    function initNav(){
      $$(".tabBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const tab = btn.dataset.tab;
          setView(tab);
        });
      });

      $("#logoutBtn").addEventListener("click", ()=> auth && auth.signOut());
      $("#loginBtn").addEventListener("click", login);
      $("#signupBtn").addEventListener("click", signup);
      $("#saveProfile").addEventListener("click", saveProfile);
      $("#startBtn").addEventListener("click", startChat);

      $("#back").addEventListener("click", closeChat);
      $("#send").addEventListener("click", sendMsg);
      $("#msg").addEventListener("input", e=> autoGrow(e.target));
      $("#msg").addEventListener("keydown", e=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          sendMsg();
        }
      });

      // Sohbet listesinde item tƒ±klandƒ±ƒüƒ±nda chat a√ß
      document.addEventListener("click", (e)=>{
        const it = e.target.closest("#threadList .item");
        if(it){
          const tid = it.dataset.tid;
          const name = it.dataset.name;
          openThread(tid, name);
        }
      });
    }

    function initFirebaseWhenReady(){
      const fbStateEl = $("#fbState");
      if(!window.firebase){
        if(fbStateEl){
          fbStateEl.textContent = " y√ºkleniyor‚Ä¶";
          fbStateEl.className = "";
        }
        setTimeout(initFirebaseWhenReady, 80);
        return;
      }

      try{
        if(firebase.apps.length === 0){
          firebase.initializeApp({
            apiKey: "AIzaSyA3--Xy1WrM6WlxurXXr4i5qwMZiafXN4k",
            authDomain: "vigochat-58144.firebaseapp.com",
            databaseURL: "https://vigochat-58144-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "vigochat-58144",
            storageBucket: "vigochat-58144.firebasestorage.app",
            messagingSenderId: "384136632816",
            appId: "1:384136632816:web:2bb6d6942680a2e2e6e535",
            measurementId: "G-62VZ3906GS"
          });
        }

        if(fbStateEl){
          fbStateEl.textContent = "OK ‚úÖ";
          fbStateEl.className = "ok";
        }
        $("#sub").textContent = "Hazƒ±r";

        auth = firebase.auth();
        state.db = firebase.firestore();

        auth.onAuthStateChanged(async (user)=>{
          if(!user){
            state.uid = null;
            state.email = "";
            $("#sub").textContent = "Giri≈ü gerekli";
            setView("auth");
            renderMustLoginHints();
            if(unsubThreads){unsubThreads(); unsubThreads=null;}
            if(unsubMsgs){unsubMsgs(); unsubMsgs=null;}
            return;
          }

          state.uid = user.uid;
          state.email = user.email || "";
          $("#sub").textContent = "Online ‚úÖ";
          renderMustLoginHints();
          await ensureUserDoc();
          setView("chats");
          subscribeThreadList();
        });

      }catch(e){
        console.log(e);
        if(fbStateEl){
          fbStateEl.textContent = "HATA ‚ùå";
          fbStateEl.className = "danger";
        }
        $("#authErr").textContent = "Firebase ba≈ülatƒ±lamadƒ±: " + (e.message || e);
      }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      setView("auth");
      renderMustLoginHints();
      initNav();
      initFirebaseWhenReady();
    });
  </script>

</body>
</html>
