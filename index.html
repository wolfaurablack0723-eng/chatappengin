<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3--Xy1WrM6WlxurXXr4i5qwMZiafXN4k",
  authDomain: "vigochat-58144.firebaseapp.com",
  projectId: "vigochat-58144",
  storageBucket: "vigochat-58144.firebasestorage.app",
  messagingSenderId: "384136632816",
  appId: "1:384136632816:web:2bb6d6942680a2e2e6e535"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userId = null;

signInAnonymously(auth);

onAuthStateChanged(auth, (user)=>{
  if(user){
    userId = user.uid;
    loadMessages();
  }
});

const chatBody = document.getElementById("chatBody");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");

function loadMessages(){
  const q = query(
    collection(db, "messages"),
    orderBy("createdAt")
  );

  onSnapshot(q, (snapshot)=>{
    chatBody.innerHTML = "";
    snapshot.forEach(doc=>{
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "bubble " + (data.uid === userId ? "me":"");
      div.textContent = data.text;
      chatBody.appendChild(div);
    });
    chatBody.scrollTop = chatBody.scrollHeight;
  });
}

sendBtn.addEventListener("click", async ()=>{
  const text = msgInput.value.trim();
  if(!text) return;

  await addDoc(collection(db,"messages"),{
    text: text,
    uid: userId,
    createdAt: serverTimestamp()
  });

  msgInput.value = "";
});
</script>
