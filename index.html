<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VigoChatt</title>
  <style>
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto;
      background:#f2f2f2;
    }
    .top{
      padding:15px;
      background:#2b6cff;
      color:white;
      font-weight:bold;
      text-align:center;
    }
    .box{
      padding:15px;
      background:white;
    }
    input{
      width:100%;
      padding:10px;
      margin-bottom:10px;
      border:1px solid #ddd;
      border-radius:6px;
    }
    button{
      width:100%;
      padding:12px;
      background:#2b6cff;
      color:white;
      border:none;
      border-radius:6px;
      font-weight:bold;
    }
    #messages{
      padding:10px;
      height:50vh;
      overflow:auto;
      background:#fff;
    }
    .msg{
      padding:8px 10px;
      margin:5px 0;
      border-radius:8px;
      background:#eee;
      font-size:14px;
    }
    .me{
      background:#2b6cff;
      color:white;
      text-align:right;
    }
  </style>
</head>
<body>

<div class="top">VigoChatt</div>

<div class="box">
  <input id="nick" placeholder="Takma ad">
  <input id="room" placeholder="Oda adı (örn: genel)" value="genel">
  <button onclick="joinRoom()">Odaya Gir</button>
</div>

<div id="messages"></div>

<div class="box">
  <input id="msg" placeholder="Mesaj yaz...">
  <button onclick="sendMsg()">Gönder</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB1qovN4BNfaFlvE-KvURhX31AshxLuc0",
  authDomain: "vigochatt.firebaseapp.com",
  projectId: "vigochatt",
  storageBucket: "vigochatt.firebasestorage.app",
  messagingSenderId: "12259504636",
  appId: "1:12259504636:web:d6ee79daceac8834d70279"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let uid = null;
let currentRoom = "genel";
let unsubscribe = null;

signInAnonymously(auth);

onAuthStateChanged(auth, user=>{
  if(user){
    uid = user.uid;
  }
});

window.joinRoom = function(){
  const room = document.getElementById("room").value.trim();
  if(!room) return;
  currentRoom = room;

  if(unsubscribe) unsubscribe();

  const q = query(collection(db,"rooms",room,"messages"), orderBy("createdAt"));
  unsubscribe = onSnapshot(q, snapshot=>{
    const box = document.getElementById("messages");
    box.innerHTML = "";
    snapshot.forEach(doc=>{
      const m = doc.data();
      const div = document.createElement("div");
      div.className = "msg" + (m.uid===uid ? " me":"");
      div.innerText = m.nick + ": " + m.text;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  });
}

window.sendMsg = async function(){
  const text = document.getElementById("msg").value.trim();
  const nick = document.getElementById("nick").value.trim() || "Anon";
  if(!text) return;

  await addDoc(collection(db,"rooms",currentRoom,"messages"),{
    text:text,
    nick:nick,
    uid:uid,
    createdAt: serverTimestamp()
  });

  document.getElementById("msg").value="";
}
</script>

</body>
</html>
